<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèÑ‚Äç‚ôÇÔ∏è SurfAI - App Intelligente (Backend)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            padding: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        
        .nav-tab {
            flex: 1;
            background: none;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
            min-width: 120px;
        }
        
        .nav-tab.active {
            background: #667eea;
            color: white;
        }
        
        .nav-tab:hover:not(.active) {
            background: #f0f0f0;
        }
        
        .tab-content {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            min-height: 500px;
        }
        
        .tab-panel {
            display: none;
        }
        
        .tab-panel.active {
            display: block;
        }
        
        .card {
            background: #f8fafc;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        
        .card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .button:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }
        
        .button.secondary {
            background: #e2e8f0;
            color: #4a5568;
        }
        
        .button.secondary:hover {
            background: #cbd5e0;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .forecast-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }
        
        .forecast-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        
        .forecast-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .forecast-card.excellent {
            border-color: #48bb78;
            background: linear-gradient(45deg, #f0fff4, #ffffff);
        }
        
        .forecast-card.good {
            border-color: #4299e1;
            background: linear-gradient(45deg, #ebf8ff, #ffffff);
        }
        
        .forecast-card.average {
            border-color: #ed8936;
            background: linear-gradient(45deg, #fffaf0, #ffffff);
        }
        
        .forecast-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .forecast-date {
            font-weight: bold;
            color: #667eea;
        }
        
        .forecast-score {
            background: #48bb78;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .forecast-score.excellent {
            background: #48bb78;
        }
        
        .forecast-score.good {
            background: #4299e1;
        }
        
        .forecast-score.average {
            background: #ed8936;
        }
        
        .forecast-score.poor {
            background: #f56565;
        }
        
        .forecast-conditions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        
        .condition {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .prediction-info {
            background: #f7fafc;
            border-radius: 6px;
            padding: 8px;
            margin-top: 8px;
            font-size: 0.85rem;
        }
        
        .prediction-recommendation {
            font-weight: 600;
            color: #4a5568;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .success {
            background: #c6f6d5;
            color: #25543e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .backend-status {
            background: #e6fffa;
            border: 1px solid #81e6d9;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
        }
        
        .backend-status.connected {
            background: #f0fff4;
            border-color: #68d391;
        }
        
        .backend-status.error {
            background: #fed7d7;
            border-color: #fc8181;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .nav-tabs {
                flex-wrap: wrap;
            }
            
            .nav-tab {
                min-width: auto;
                flex: 1;
            }
            
            .forecast-grid {
                grid-template-columns: 1fr;
            }
            .auth-container {
                background: white;
                border-radius: 12px;
                padding: 30px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                margin-bottom: 20px;
            }
            
            .auth-tabs {
                display: flex;
                margin-bottom: 30px;
                border-radius: 8px;
                overflow: hidden;
                border: 2px solid #e2e8f0;
            }
            
            .auth-tab {
                flex: 1;
                padding: 15px;
                text-align: center;
                background: #f8fafc;
                cursor: pointer;
                transition: all 0.3s ease;
                font-weight: 600;
                border: none;
            }
            
            .auth-tab.active {
                background: #667eea;
                color: white;
            }
            
            .auth-form {
                display: none;
            }
            
            .auth-form.active {
                display: block;
            }
            
            .profiles-container {
                background: white;
                border-radius: 12px;
                padding: 30px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            }
            
            .hidden {
                display: none !important;
            }
            
            .spot-favorite-card, .board-card {
                background: white;
                border: 2px solid #e2e8f0;
                border-radius: 8px;
                padding: 15px;
                margin-bottom: 10px;
                transition: all 0.3s ease;
            }
            
            .spot-favorite-card:hover, .board-card:hover {
                border-color: #667eea;
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            }
            
            .shaper-link {
                color: #667eea;
                text-decoration: underline;
                cursor: pointer;
                font-weight: 600;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üèÑ‚Äç‚ôÇÔ∏è SurfAI</h1>
            <p>Version Backend S√©curis√©e - Intelligence de surf avanc√©e</p>
        </div>
        
        <!-- Backend Status -->
        <div id="backend-status" class="backend-status">
            <div style="display: flex; align-items: center; gap: 10px;">
                <span id="backend-indicator">üîµ</span>
                <span id="backend-message">V√©rification connexion backend...</span>
            </div>
        </div>
        
        <!-- Navigation -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="nav-tab" onclick="showTab('sessions')">üèÑ‚Äç‚ôÇÔ∏è Sessions</button>
            <button class="nav-tab" onclick="showTab('spots')">üìç Spots</button>
            <button class="nav-tab" onclick="showAuthOrprofiles()">üë§ profiles</button>
            <button class="nav-tab" onclick="showTab('predictions')">üéØ Pr√©dictions</button>
            <button class="nav-tab" onclick="showTab('meteo')">üåä M√©t√©o</button>
            <button class="nav-tab" onclick="showTab('config')">‚öôÔ∏è Configuration</button>
        </div>
        
        <!-- Content -->
        <div class="tab-content">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-panel active">
                <h2>üìä Tableau de bord</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="total-sessions">-</div>
                        <div class="stat-label">Sessions totales</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avg-rating">-</div>
                        <div class="stat-label">Note moyenne</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="favorite-spots">-</div>
                        <div class="stat-label">Spots favoris</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="backend-status-indicator">üî¥</div>
                        <div class="stat-label">Backend SurfAI</div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>üéØ Prochaines sessions recommand√©es (IA)</h3>
                    <div id="recommendations">
                        <div class="loading">Chargement des recommandations intelligentes...</div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>üìà Vos patterns de surf</h3>
                    <div id="patterns">
                        <p>Analysez vos sessions pour d√©couvrir vos conditions pr√©f√©r√©es !</p>
                        <button class="button" onclick="analyzePatterns()">Analyser mes patterns</button>
                    </div>
                </div>
            </div>
            
            <!-- Sessions Tab -->
            <div id="sessions" class="tab-panel">
                <h2>üèÑ‚Äç‚ôÇÔ∏è Mes Sessions</h2>
                
                <div class="card">
                    <h3>‚ûï Ajouter une nouvelle session</h3>
                    <div id="session-form">
                        <div class="form-group">
                            <label>Date de la session</label>
                            <input type="date" id="session-date" required>
                        </div>
                        
                        <!-- Navigation hi√©rarchique des spots -->
                        <div class="form-group">
                            <label>Pays</label>
                            <select id="session-country" onchange="updateRegions()" required>
                                <option value="">S√©lectionnez un pays</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>R√©gion</label>
                            <select id="session-region" onchange="updateCities()" required>
                                <option value="">S√©lectionnez une r√©gion</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ville</label>
                            <select id="session-city" onchange="updateSpots()" required>
                                <option value="">S√©lectionnez une ville</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Spot</label>
                            <select id="session-spot" required>
                                <option value="">S√©lectionnez un spot</option>
                            </select>
                        </div>
                        
                        <!-- S√©lection board depuis profil -->
                        <div class="form-group">
                            <label>Board utilis√©e (optionnel)</label>
                            <select id="session-board">
                                <option value="">Aucune board s√©lectionn√©e</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Note de la session (1-10)</label>
                            <select id="session-rating" required>
                                <option value="">Choisir une note</option>
                                <option value="1">1 ‚≠ê - D√©cevant</option>
                                <option value="2">2 ‚≠ê - Faible</option>
                                <option value="3">3 ‚≠ê - Correct</option>
                                <option value="4">4 ‚≠ê - Bon</option>
                                <option value="5">5 ‚≠ê - Tr√®s bon</option>
                                <option value="6">6 ‚≠ê - Excellent</option>
                                <option value="7">7 ‚≠ê - Super</option>
                                <option value="8">8 ‚≠ê - G√©nial</option>
                                <option value="9">9 ‚≠ê - Parfait</option>
                                <option value="10">10 ‚≠ê - L√©gendaire</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Commentaires</label>
                            <textarea id="session-notes" rows="3" placeholder="D√©crivez votre session..."></textarea>
                        </div>
                        <button onclick="submitSession()" class="button">üíæ Enregistrer la session</button>
                    </div>
                </div>
                
                <div class="card">
                    <h3>üìã Historique des sessions</h3>
                    <div id="sessions-list">
                        <div class="loading">Chargement des sessions...</div>
                    </div>
                </div>
            </div>
            
            <!-- Spots Tab -->
            <div id="spots" class="tab-panel">
                <h2>üìç Mes Spots</h2>
                
                <!-- Navigation hi√©rarchique -->
                <div class="card">
                    <h3>üó∫Ô∏è Explorer les spots</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label>Pays</label>
                            <select id="spots-country" onchange="updateSpotsNavigation()">
                                <option value="">Tous les pays</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>R√©gion</label>
                            <select id="spots-region" onchange="updateSpotsNavigation()">
                                <option value="">Toutes les r√©gions</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ville</label>
                            <select id="spots-city" onchange="updateSpotsNavigation()">
                                <option value="">Toutes les villes</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>‚≠ê Spots favoris</h3>
                    <div id="favorite-spots-list">
                        <div class="loading">Chargement des spots favoris...</div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>üåä Spots disponibles</h3>
                    <div id="all-spots-list">
                        <div class="loading">Chargement des spots...</div>
                    </div>
                </div>
            </div>
            
            <!-- profiles Tab - Version compl√®te selon sp√©cifications -->
            <div id="profiles" class="tab-panel">
                <!-- Section Authentification (visible si non connect√©) -->
                <div id="auth-section" class="auth-container">
                    <h2>Connexion & Inscription</h2>
                    
                    <div class="auth-tabs">
                        <div class="auth-tab active" onclick="switchAuthTab('login')">Connexion</div>
                        <div class="auth-tab" onclick="switchAuthTab('register')">Inscription</div>
                    </div>
                    
                    <!-- Formulaire de connexion -->
                    <div id="login-form" class="auth-form active">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="login-email" placeholder="votre@email.com" required>
                        </div>
                        <div class="form-group">
                            <label>Mot de passe</label>
                            <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                        </div>
                        <button onclick="handleLogin()" class="button">Se connecter</button>
                        <div style="text-align: center; margin-top: 15px;">
                            <a href="#" onclick="showForgotPassword()" style="color: #667eea;">Mot de passe oubli√© ?</a>
                        </div>
                    </div>
                    
                    <!-- Formulaire d'inscription -->
                    <div id="register-form" class="auth-form">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                            <div class="form-group">
                                <label>Pr√©nom</label>
                                <input type="text" id="register-firstname" placeholder="Votre pr√©nom" required>
                            </div>
                            <div class="form-group">
                                <label>Nom</label>
                                <input type="text" id="register-lastname" placeholder="Votre nom" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="register-email" placeholder="votre@email.com" required>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                            <div class="form-group">
                                <label>Mot de passe</label>
                                <input type="password" id="register-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                            </div>
                            <div class="form-group">
                                <label>Confirmer mot de passe</label>
                                <input type="password" id="register-password-confirm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Niveau de surf</label>
                            <select id="register-level" required>
                                <option value="">S√©lectionnez votre niveau</option>
                                <option value="beginner">D√©butant</option>
                                <option value="intermediate">Interm√©diaire</option>
                                <option value="advanced">Avanc√©</option>
                                <option value="expert">Expert</option>
                            </select>
                        </div>
                        <button onclick="handleRegister()" class="button">Cr√©er mon compte</button>
                    </div>
                    
                    <div id="auth-messages"></div>
                </div>
                
                <!-- Section Profil (visible si connect√©) -->
                <div id="profiles-section" class="profiles-container hidden">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>Mon Profil</h2>
                        <button onclick="handleLogout()" class="button secondary">D√©connexion</button>
                    </div>
                    
                    <!-- 1. MODIFIER MON profiles -->
                    <div class="card">
                        <h3>Modifier mon profil</h3>
                        
                        <!-- Photo de profil -->
                        <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #e2e8f0;">
                            <div style="position: relative;">
                                <div id="avatar-display" class="avatar-placeholder" onclick="triggerPhotoUpload()" 
                                     style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(45deg, #667eea, #764ba2); 
                                            display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; 
                                            font-weight: bold; cursor: pointer; transition: transform 0.3s ease;">SU</div>
                                <button onclick="triggerPhotoUpload()" 
                                        style="position: absolute; bottom: 0; right: 0; background: #667eea; color: white; border: none; 
                                               border-radius: 50%; width: 25px; height: 25px; cursor: pointer; font-size: 0.7rem;">üì∑</button>
                                <input type="file" id="avatar-input" accept="image/*" style="display: none;" onchange="handlePhotoUpload(event)">
                            </div>
                            <div>
                                <h4 id="profiles-display-name" style="color: #667eea; margin-bottom: 5px;">Utilisateur SurfAI</h4>
                                <div id="profiles-display-email" style="color: #666; font-size: 0.9rem;">email@example.com</div>
                                <div id="profiles-verification-status" style="display: inline-block; padding: 4px 8px; border-radius: 12px; 
                                     font-size: 0.8rem; font-weight: 600; margin-top: 5px; background: #fed7d7; color: #c53030;">
                                    Email non v√©rifi√©
                                </div>
                            </div>
                        </div>
                        
                        <!-- Informations de base -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="profiles-email" placeholder="votre@email.com">
                            </div>
                            <div class="form-group">
                                <label>Pseudo</label>
                                <input type="text" id="profiles-nickname" placeholder="Votre pseudo de surfeur">
                            </div>
                        </div>
                        
                        <!-- Changement mot de passe -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                            <div class="form-group">
                                <label>Nouveau mot de passe</label>
                                <input type="password" id="profiles-new-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                            </div>
                            <div class="form-group">
                                <label>Confirmer nouveau mot de passe</label>
                                <input type="password" id="profiles-new-password-confirm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                            </div>
                        </div>
                        
                        <button onclick="updateProfile()" class="button">Sauvegarder les modifications</button>
                    </div>
                    
                    <!-- 2. NIVEAU DE SURF -->
                    <div class="card">
                        <h3>Choisir son niveau</h3>
                        <div class="form-group">
                            <label>Niveau de surf</label>
                            <select id="profiles-surf-level" style="font-size: 1.1rem; padding: 15px;">
                                <option value="beginner">D√©butant - J'apprends les bases</option>
                                <option value="intermediate" selected>Interm√©diaire - Je surfe en autonomie</option>
                                <option value="advanced">Avanc√© - Je ma√Ætrise les man≈ìuvres</option>
                                <option value="expert">Expert - Je surfe toutes conditions</option>
                            </select>
                        </div>
                        <button onclick="updateSurfLevel()" class="button">Mettre √† jour mon niveau</button>
                    </div>
                    
                    <!-- 3. TAILLE DES VAGUES -->
                    <div class="card">
                        <h3>La taille des vagues que je surfe</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                            <div class="form-group">
                                <label>Taille minimum (m√®tres)</label>
                                <input type="number" id="profiles-wave-min" step="0.1" min="0.3" max="5" placeholder="0.7" value="0.7">
                                <small style="color: #666;">Plus petite vague que vous surfez</small>
                            </div>
                            <div class="form-group">
                                <label>Taille maximum (m√®tres)</label>
                                <input type="number" id="profiles-wave-max" step="0.1" min="0.5" max="8" placeholder="1.8" value="1.8">
                                <small style="color: #666;">Plus grosse vague que vous osez prendre</small>
                            </div>
                        </div>
                        <button onclick="updateWavePreferences()" class="button">Sauvegarder mes pr√©f√©rences</button>
                    </div>
                    
                    <!-- 4. MES SPOTS FAVORIS -->
                    <div class="card">
                        <h3>Mes spots favoris</h3>
                        <p style="color: #666; margin-bottom: 15px;">
                            Pour ajouter des spots favoris, rendez-vous dans l'onglet 
                            <button onclick="showTab('spots')" class="button secondary" style="display: inline; padding: 4px 8px; font-size: 0.9rem;">Spots</button>
                        </p>
                        <div id="profiles-favorite-spots">
                            <div class="loading">Chargement de vos spots favoris...</div>
                        </div>
                    </div>
                    
                    <!-- 5. MES BOARDS -->
                    <div class="card">
                        <h3>Mes boards</h3>
                        
                        <!-- Formulaire ajout board -->
                        <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h4>Ajouter une board</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div class="form-group">
                                    <label>Nom de la board</label>
                                    <input type="text" id="board-name" placeholder="Ex: Ma Longboard" required>
                                </div>
                                <div class="form-group">
                                    <label>Taille (pouces)</label>
                                    <input type="text" id="board-size" placeholder="Ex: 9'2" required>
                                </div>
                                <div class="form-group">
                                    <label>Type</label>
                                    <select id="board-type" required>
                                        <option value="">Choisir un type</option>
                                        <option value="longboard">Longboard</option>
                                        <option value="midlength">Midlength</option>
                                        <option value="shortboard">Shortboard</option>
                                        <option value="fish">Fish</option>
                                        <option value="gun">Gun</option>
                                        <option value="funboard">Funboard</option>
                                        <option value="sup">SUP</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Shaper</label>
                                    <input type="text" id="board-shaper" placeholder="Ex: Robert August" required>
                                </div>
                            </div>
                            <button onclick="addBoard()" class="button">Ajouter cette board</button>
                        </div>
                        
                        <!-- Liste des boards -->
                        <div id="user-boards-list">
                            <div class="loading">Chargement de vos boards...</div>
                        </div>
                    </div>
                    
                    <div id="profiles-messages"></div>
                </div>
            </div>
            
            <!-- CSS suppl√©mentaire pour l'authentification -->
            <style>
                .auth-container {
                    background: white;
                    border-radius: 12px;
                    padding: 30px;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                    margin-bottom: 20px;
                }
                
                .auth-tabs {
                    display: flex;
                    margin-bottom: 30px;
                    border-radius: 8px;
                    overflow: hidden;
                    border: 2px solid #e2e8f0;
                }
                
                .auth-tab {
                    flex: 1;
                    padding: 15px;
                    text-align: center;
                    background: #f8fafc;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    font-weight: 600;
                    border: none;
                }
                
                .auth-tab.active {
                    background: #667eea;
                    color: white;
                }
                
                .auth-form {
                    display: none;
                }
                
                .auth-form.active {
                    display: block;
                }
                
                .profiles-container {
                    background: white;
                    border-radius: 12px;
                    padding: 30px;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                }
                
                .hidden {
                    display: none !important;
                }
                
                .avatar-placeholder:hover {
                    transform: scale(1.05);
                }
                
                .spot-favorite-card {
                    background: white;
                    border: 2px solid #e2e8f0;
                    border-radius: 8px;
                    padding: 15px;
                    margin-bottom: 10px;
                    transition: all 0.3s ease;
                }
                
                .spot-favorite-card:hover {
                    border-color: #667eea;
                    transform: translateY(-2px);
                    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                }
                
                .spot-name {
                    font-weight: bold;
                    color: #667eea;
                    font-size: 1.1rem;
                    margin-bottom: 5px;
                }
                
                .spot-location {
                    color: #666;
                    font-size: 0.9rem;
                    margin-bottom: 10px;
                }
                
                .board-card {
                    background: white;
                    border: 2px solid #e2e8f0;
                    border-radius: 8px;
                    padding: 15px;
                    margin-bottom: 10px;
                    transition: all 0.3s ease;
                }
                
                .board-card:hover {
                    border-color: #667eea;
                    transform: translateY(-2px);
                    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                }
                
                .board-name {
                    font-weight: bold;
                    color: #667eea;
                    font-size: 1.1rem;
                    margin-bottom: 5px;
                }
                
                .board-details {
                    color: #666;
                    font-size: 0.9rem;
                    margin-bottom: 10px;
                }
                
                .shaper-link {
                    color: #667eea;
                    text-decoration: underline;
                    cursor: pointer;
                    font-weight: 600;
                }
                
                .shaper-link:hover {
                    color: #5a67d8;
                }
            </style>
            
            <script>
                // Configuration Supabase
                const supabaseUrl = 'https://zssiqpxlqshsmhpqjzgb.supabase.co';
                const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpzc2lxcHhscXNoc21ocHFqemdiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUwNTY5MzgsImV4cCI6MjA2MDYzMjkzOH0.H7tpOyc-iFCQLf4eHOMfJ0T09NvpHy_6kw2onaiJJcw'; // √Ä remplacer
                let currentUser = null;
                let supabaseAuth = null;
            
                // ===== GESTION AUTHENTIFICATION =====
                
                async function checkAuthState() {
                    if (!supabaseAuth) return;
                    
                    try {
                        const { data: { user } } = await supabaseAuth.auth.getUser();
                        if (user) {
                            currentUser = user;
                            showprofilesSection();
                            await loadUserprofiles();
                        } else {
                            showAuthSection();
                        }
                    } catch (error) {
                        console.error('Erreur v√©rification auth:', error);
                        showAuthSection();
                    }
                }
                
                function switchAuthTab(tab) {
                    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
                    document.querySelector(`.auth-tab:nth-child(${tab === 'login' ? '1' : '2'})`).classList.add('active');
                    
                    document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
                    document.getElementById(tab === 'login' ? 'login-form' : 'register-form').classList.add('active');
                    
                    clearMessages('auth');
                }
                
                async function handleLogin() {
                    if (!supabaseAuth) {
                        showMessage('auth', 'error', 'Supabase non configur√©');
                        return;
                    }
                    
                    const email = document.getElementById('login-email').value;
                    const password = document.getElementById('login-password').value;
                    
                    if (!email || !password) {
                        showMessage('auth', 'error', 'Veuillez remplir tous les champs');
                        return;
                    }
                    
                    try {
                        const { data, error } = await supabaseAuth.auth.signInWithPassword({
                            email,
                            password
                        });
                        
                        if (error) throw error;
                        
                        currentUser = data.user;
                        
                        // Synchroniser avec dataManager existant
                        if (window.dataManager) {
                            window.dataManager.currentUserId = data.user.id;
                        }
                        
                        showMessage('auth', 'success', 'Connexion r√©ussie !');
                        
                        setTimeout(() => {
                            showprofilesSection();
                            loadUserprofiles();
                        }, 1000);

                        
                    } catch (error) {
                        console.error('Erreur connexion:', error);
                        showMessage('auth', 'error', `Erreur: ${error.message}`);
                    }
                }
                
                async function handleRegister() {
                    if (!supabaseAuth) {
                        showMessage('auth', 'error', 'Supabase non configur√©');
                        return;
                    }
                    
                    const email = document.getElementById('register-email').value;
                    const password = document.getElementById('register-password').value;
                    const passwordConfirm = document.getElementById('register-password-confirm').value;
                    const firstname = document.getElementById('register-firstname').value;
                    const lastname = document.getElementById('register-lastname').value;
                    const level = document.getElementById('register-level').value;
                    
                    if (!email || !password || !firstname || !lastname || !level) {
                        showMessage('auth', 'error', 'Veuillez remplir tous les champs');
                        return;
                    }
                    
                    if (password !== passwordConfirm) {
                        showMessage('auth', 'error', 'Les mots de passe ne correspondent pas');
                        return;
                    }
                    
                    if (password.length < 6) {
                        showMessage('auth', 'error', 'Le mot de passe doit contenir au moins 6 caract√®res');
                        return;
                    }
                    
                    try {
                        const { data, error } = await supabaseAuth.auth.signUp({
                            email,
                            password,
                            options: {
                                data: {
                                    first_name: firstname,
                                    last_name: lastname,
                                    surf_level: level,
                                    full_name: `${firstname} ${lastname}`
                                }
                            }
                        });
                        
                        if (error) throw error;
                        
                        showMessage('auth', 'success', 'Inscription r√©ussie ! V√©rifiez votre email pour confirmer votre compte.');
                        
                        if (data.user) {
                            const { error: profileError } = await supabaseAuth
    .from('profiles')
    .insert([{
        id: data.user.id,
        surf_level: level,
        nickname: firstname,
        min_wave_height: 0.7,
        max_wave_height: 1.8,
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
    }]);

if (profileError) {
    console.error('Erreur cr√©ation profil:', profileError);
} else {
    console.log('Profil cr√©√© avec succ√®s');
}

currentUser = data.user;
                        }
                        
                    } catch (error) {
                        console.error('Erreur inscription:', error);
                        showMessage('auth', 'error', `Erreur: ${error.message}`);
                    }
                }
                
                async function handleLogout() {
                    if (!supabaseAuth) return;
                    
                    try {
                        const { error } = await supabaseAuth.auth.signOut();
                        if (error) throw error;
                        
                        currentUser = null;
                        showAuthSection();
                        
                    } catch (error) {
                        console.error('Erreur d√©connexion:', error);
                    }
                }
                
                // ===== GESTION PROFIL =====
                
                async function createUserprofiles(user, additionalData) {
                console.log('Cr√©ation profil pour:', user.id, additionalData);
                
                if (!window.supabaseAuth) {
                    console.error('supabaseAuth non disponible');
                    return;
                }
                
                try {
                    const { error } = await window.supabaseAuth
                        .from('profiles')
                        .upsert([{
                            uuid: user.id,
                            email: user.email,
                            nickname: additionalData.firstname,
                            surf_level: additionalData.level,
                            min_wave_height: 0.7,
                            max_wave_height: 1.8,
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        }]);
                    
                    if (error) {
                        console.error('Erreur Supabase:', error);
                        throw error;
                    }
                    
                    console.log('Profil cr√©√© avec succ√®s dans Supabase');
                    
                } catch (error) {
                    console.error('Erreur cr√©ation profil:', error);
                }
            }
                
                async function loadUserprofiles() {
                    if (!currentUser || !window.dataManager) return;
                    
                    try {
                        const profiles = await dataManager.getUserProfile(currentUser.id);
                        
                        if (profiles) {
                            document.getElementById('profiles-display-name').textContent = 
                                currentUser.user_metadata?.full_name || profiles.personal?.name || 'Utilisateur SurfAI';
                            document.getElementById('profiles-display-email').textContent = currentUser.email;
                            
                            // Statut email
                            const verificationElement = document.getElementById('profiles-verification-status');
                            if (currentUser.email_confirmed_at) {
                                verificationElement.textContent = 'Email v√©rifi√©';
                                verificationElement.style.background = '#c6f6d5';
                                verificationElement.style.color = '#25543e';
                            } else {
                                verificationElement.textContent = 'Email non v√©rifi√©';
                                verificationElement.style.background = '#fed7d7';
                                verificationElement.style.color = '#c53030';
                            }
                            
                            // Remplir les champs
                            if (profiles.personal) {
                                document.getElementById('profiles-email').value = currentUser.email;
                                document.getElementById('profiles-nickname').value = profiles.personal.name || '';
                            }
                            
                            if (profiles.surfLevel) {
                                document.getElementById('profiles-surf-level').value = 
                                    typeof profiles.surfLevel.overall === 'number' 
                                        ? convertNumericToLevel(profiles.surfLevel.overall) 
                                        : profiles.surfLevel.overall || 'intermediate';
                            }
                            
                            if (profiles.preferences?.waveSize) {
                                document.getElementById('profiles-wave-min').value = profiles.preferences.waveSize.min || 0.7;
                                document.getElementById('profiles-wave-max').value = profiles.preferences.waveSize.max || 1.8;
                            }
                        }
                        
                        // Charger spots favoris et boards
                        await loadprofilesFavoriteSpots();
                        await loadUserBoards();
                        
                        updateAvatarDisplay();
                        
                    } catch (error) {
                        console.error('Erreur chargement profil:', error);
                    }
                }
                
                // ===== FONCTIONS SP√âCIFIQUES =====
                
                async function updateProfile() {
                if (!currentUser || !supabaseAuth) return;
                
                const email = document.getElementById('profile-email').value;
                const nickname = document.getElementById('profile-nickname').value;
                const newPassword = document.getElementById('profile-new-password').value;
                const confirmPassword = document.getElementById('profile-new-password-confirm').value;
                
                try {
                    // Mettre √† jour le profil
                    if (nickname) {
                        const { error } = await supabaseAuth.from('profiles')
                            .update({ 
                                nickname: nickname,
                                updated_at: new Date().toISOString() 
                            })
                            .eq('id', currentUser.id);
                            .select();
                        
                        if (error) throw error;
                    }
                    
                    // Mettre √† jour le mot de passe
                    if (newPassword) {
                        if (newPassword !== confirmPassword) {
                            showMessage('profile', 'error', 'Les mots de passe ne correspondent pas');
                            return;
                        }
                        
                        if (newPassword.length < 6) {
                            showMessage('profile', 'error', 'Le mot de passe doit contenir au moins 6 caract√®res');
                            return;
                        }
                        
                        const { error } = await supabaseAuth.auth.updateUser({ password: newPassword });
                        if (error) throw error;
                        
                        document.getElementById('profile-new-password').value = '';
                        document.getElementById('profile-new-password-confirm').value = '';
                    }
                    
                    showMessage('profile', 'success', 'Profil mis √† jour avec succ√®s !');
                    
                } catch (error) {
                    console.error('Erreur mise √† jour profil:', error);
                    showMessage('profile', 'error', `Erreur: ${error.message}`);
                }
            }
                
                async function updateSurfLevel() {
                if (!currentUser || !supabaseAuth) {
                    showMessage('profiles', 'error', 'Erreur: utilisateur non connect√©');
                    return;
                }
                
                const level = document.getElementById('profiles-surf-level').value;
                
                try {
                    const result = await supabaseAuth.from('profiles')
                        .update({ 
                            surf_level: level,
                            updated_at: new Date().toISOString() 
                        })
                        .eq('id', currentUser.id)
                        .select();
                    
                    if (result.error) {
                        throw result.error;
                    }
                    
                    if (result.data.length === 0) {
                        throw new Error('Profil non trouv√©');
                    }
                    
                    showMessage('profiles', 'success', 'Niveau de surf mis √† jour !');
                    
                } catch (error) {
                    console.error('Erreur:', error);
                    showMessage('profiles', 'error', `Erreur: ${error.message}`);
                }
            }
                
                async function updateWavePreferences() {
                if (!currentUser || !supabaseAuth) return;
                
                const waveMin = parseFloat(document.getElementById('profiles-wave-min').value);
                const waveMax = parseFloat(document.getElementById('profiles-wave-max').value);
                
                if (waveMin >= waveMax) {
                    showMessage('profiles', 'error', 'La taille minimum doit √™tre inf√©rieure √† la taille maximum');
                    return;
                }
                
                try {
                    const { error, data } = await supabaseAuth.from('profiles')
                        .update({ 
                            min_wave_height: waveMin,
                            max_wave_height: waveMax,
                            updated_at: new Date().toISOString() 
                        })
                        .eq('id', currentUser.id)
                        .select();
                    
                    if (error) throw error;
                    if (!data || data.length === 0) throw new Error('Profil non trouv√©');
                    
                    showMessage('profiles', 'success', 'Pr√©f√©rences de vagues mises √† jour !');
                    
                } catch (error) {
                    console.error('Erreur mise √† jour vagues:', error);
                    showMessage('profiles', 'error', `Erreur: ${error.message}`);
                }
            }

                
                async function loadprofilesFavoriteSpots() {
                    if (!window.dataManager?.supabase) {
                        document.getElementById('profiles-favorite-spots').innerHTML = `
                            <div class="spot-favorite-card">
                                <p>Configuration Supabase requise pour afficher les favoris.</p>
                            </div>
                        `;
                        return;
                    }
                    
                    try {
                        const { data: favorites, error } = await dataManager.supabase
                            .from('favorite_spots')
                            .select(`
                                spot_id,
                                spots (
                                    id, name, city, region, country, bottom_type
                                )
                            `)
                            .eq('user_id', currentUser.id);
                        
                        if (error) throw error;
                        
                        displayprofilesFavoriteSpots(favorites || []);
                        
                    } catch (error) {
                        console.error('Erreur chargement favoris:', error);
                        document.getElementById('profiles-favorite-spots').innerHTML = `
                            <div class="spot-favorite-card">
                                <p>Erreur chargement favoris: ${error.message}</p>
                            </div>
                        `;
                    }
                }
                
                function displayprofilesFavoriteSpots(favorites) {
                    const container = document.getElementById('profiles-favorite-spots');
                    
                    if (favorites.length === 0) {
                        container.innerHTML = `
                            <div class="spot-favorite-card">
                                <p>Aucun spot favori pour le moment.</p>
                                <p>Rendez-vous dans l'onglet Spots pour en ajouter !</p>
                            </div>
                        `;
                        return;
                    }
                    
                    let html = '';
                    favorites.forEach(fav => {
                        const spot = fav.spots;
                        if (spot) {
                            html += `
                                <div class="spot-favorite-card">
                                    <div class="spot-name">${spot.name}</div>
                                    <div class="spot-location">${spot.city}, ${spot.region}, ${spot.country}</div>
                                    <div style="margin-top: 10px;">
                                        <button onclick="showSpotInfo('${spot.id}')" class="button secondary" style="padding: 6px 12px; font-size: 0.9rem; margin-right: 10px;">
                                            Plus d'info
                                        </button>
                                        <button onclick="removeFavoriteFromprofiles('${spot.id}')" class="button danger" style="padding: 6px 12px; font-size: 0.9rem;">
                                            Supprimer
                                        </button>
                                    </div>
                                </div>
                            `;
                        }
                    });
                    
                    container.innerHTML = html;
                }
                                
                async function loadUserBoards() {
                    if (!window.dataManager) return;
                    
                    try {
                        const boards = await dataManager.getUserBoards(currentUser.id);
                        displayUserBoards(boards);
                        
                    } catch (error) {
                        console.error('Erreur chargement boards:', error);
                    }
                }
                
                function displayUserBoards(boards) {
                    const container = document.getElementById('user-boards-list');
                    
                    if (boards.length === 0) {
                        container.innerHTML = `
                            <div class="board-card">
                                <p>Aucune board enregistr√©e.</p>
                                <p>Ajoutez vos boards ci-dessus !</p>
                            </div>
                        `;
                        return;
                    }
                    
                    let html = '';
                    boards.forEach(board => {
                        html += `
                            <div class="board-card">
                                <div class="board-name">${board.name}</div>
                                <div class="board-details">
                                    <strong>Taille:</strong> ${board.size} ‚Ä¢ 
                                    <strong>Type:</strong> ${board.type} ‚Ä¢ 
                                    <strong>Shaper:</strong> <span class="shaper-link" onclick="showShaperInfo('${board.shaper}')">${board.shaper}</span>
                                </div>
                                <div style="margin-top: 10px;">
                                    <button onclick="editBoard(${board.id})" class="button secondary" style="padding: 6px 12px; font-size: 0.9rem; margin-right: 10px;">
                                        Modifier
                                    </button>
                                    <button onclick="deleteBoard(${board.id})" class="button danger" style="padding: 6px 12px; font-size: 0.9rem;">
                                        Supprimer
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    container.innerHTML = html;
                }
                
                // ===== FONCTIONS UTILITAIRES =====
                
                function showAuthSection() {
                    document.getElementById('auth-section').classList.remove('hidden');
                    document.getElementById('profiles-section').classList.add('hidden');
                }
                
                function showprofilesSection() {
                    document.getElementById('auth-section').classList.add('hidden');
                    document.getElementById('profiles-section').classList.remove('hidden');
                }
                
                function showMessage(section, type, message) {
                    const container = document.getElementById(`${section}-messages`);
                    container.innerHTML = `<div class="${type}">${message}</div>`;
                    setTimeout(() => container.innerHTML = '', 5000);
                }
                
                function clearMessages(section) {
                    document.getElementById(`${section}-messages`).innerHTML = '';
                }
                
                function updateAvatarDisplay() {
                    // Logique d'avatar √† impl√©menter selon besoins
                    const avatarDisplay = document.getElementById('avatar-display');
                    const initials = getInitials();
                    avatarDisplay.textContent = initials;
                }
                
                function getInitials() {
                    const name = currentUser?.user_metadata?.full_name || 'SU';
                    return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                }
                
                function convertNumericToLevel(numeric) {
                    if (numeric <= 2) return 'beginner';
                    if (numeric <= 5) return 'intermediate';
                    if (numeric <= 8) return 'advanced';
                    return 'expert';
                }
                
                // Fonctions callbacks pour les actions
                function showSpotInfo(spotId) {
                    showMessage('profiles', 'info', 'Redirection vers fiche spot (√† impl√©menter)');
                }
                
                function removeFavoriteFromprofiles(spotId) {
                    if (window.toggleFavorite) {
                        toggleFavorite(spotId).then(() => {
                            loadprofilesFavoriteSpots();
                        });
                    }
                }
                
                function showShaperInfo(shaperName) {
                    showMessage('profiles', 'info', `Fiche shaper ${shaperName} (fonctionnalit√© future)`);
                }
                
                function editBoard(boardId) {
                    showMessage('profiles', 'info', '√âdition board (√† impl√©menter)');
                }
                
                function deleteBoard(boardId) {
                    if (confirm('Supprimer cette board ?')) {
                        showMessage('profiles', 'success', 'Board supprim√©e');
                        loadUserBoards();
                    }
                }
                
                function triggerPhotoUpload() {
                    document.getElementById('avatar-input').click();
                }
                
                function handlePhotoUpload(event) {
                    showMessage('profiles', 'info', 'Upload photo (√† impl√©menter avec Storage)');
                }
                
                function showForgotPassword() {
                    const email = prompt('Email pour r√©initialisation:');
                    if (email && supabaseAuth) {
                        supabaseAuth.auth.resetPasswordForEmail(email).then(() => {
                            showMessage('auth', 'success', 'Email de r√©initialisation envoy√©');
                        });
                    }
                }
                
                // Modifier la fonction showTab existante pour g√©rer l'auth
                function showAuthOrprofiles() {
                    checkAuthState();
                }
                
                // Initialisation
                document.addEventListener('DOMContentLoaded', async function() {
                // Date par d√©faut
                document.getElementById('session-date').value = new Date().toISOString().split('T')[0];
                
                // Initialiser Supabase directement pour l'authentification
                if (typeof window.supabase !== 'undefined') {
                    const supabaseUrl = 'https://zssiqpxlqshsmhpqjzgb.supabase.co';
                    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpzc2lxcHhscXNoc21ocHFqemdiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUwNTY5MzgsImV4cCI6MjA2MDYzMjkzOH0.H7tpOyc-iFCQLf4eHOMfJ0T09NvpHy_6kw2onaiJJcw';
                    
                    supabaseAuth = window.supabase.createClient(supabaseUrl, supabaseKey);
                    window.supabaseAuth = supabaseAuth;
                    console.log('Supabase initialis√© pour authentification');

                    // Cr√©er un dataManager simple pour compatibilit√©
                    window.dataManager = {
                        supabase: window.supabaseAuth,
                        currentUserId: '3ba8ad73-e2c6-4971-8b32-5a123456789a'
                    };

                    console.log('DataManager simple cr√©√©');
                }

                // V√©rifier l'√©tat d'authentification au chargement
                if (document.getElementById('profiles') && window.supabaseAuth) {
                    checkAuthState();
                }
            });
            </script>
            
            <!-- Meteo Tab -->
            <div id="meteo" class="tab-panel">
                <h2>üåä M√©t√©o Marine</h2>
                
                <div class="card">
                    <h3>üß™ Test Backend SurfAI</h3>
                    <p>Testez votre connexion au backend s√©curis√©</p>
                    <button class="button" onclick="testBackendConnection()">üîç Tester le Backend</button>
                    <div id="backend-test-result"></div>
                </div>
                
                <div class="card">
                    <h3>üì° Pr√©visions en temps r√©el</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <!-- Navigation spots hi√©rarchique pour m√©t√©o -->
                        <div class="form-group">
                            <label>Pays</label>
                            <select id="forecast-country" onchange="updateForecastRegions()">
                                <option value="">S√©lectionnez un pays</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>R√©gion</label>
                            <select id="forecast-region" onchange="updateForecastCities()">
                                <option value="">S√©lectionnez une r√©gion</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ville</label>
                            <select id="forecast-city" onchange="updateForecastSpots()">
                                <option value="">S√©lectionnez une ville</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Spot</label>
                            <select id="forecast-spot">
                                <option value="">S√©lectionnez un spot</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Votre niveau</label>
                            <select id="forecast-level">
                                <option value="beginner">üå± D√©butant</option>
                                <option value="intermediate" selected>üèÑ‚Äç‚ôÇÔ∏è Interm√©diaire</option>
                                <option value="advanced">üåä Avanc√©</option>
                                <option value="expert">üèÜ Expert</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Board (optionnel)</label>
                            <select id="forecast-board">
                                <option value="">Aucune board</option>
                            </select>
                        </div>
                    </div>
                    <button class="button" onclick="getIntelligentForecast()">üåä R√©cup√©rer pr√©visions IA</button>
                    <div id="forecast-result">
                        <div class="forecast-grid" id="forecast-grid"></div>
                    </div>
                </div>
            </div>
            
            <!-- Config Tab -->
            <div id="config" class="tab-panel">
                <h2>‚öôÔ∏è Configuration</h2>
                
                <div class="card">
                    <h3>üöÄ Configuration Backend SurfAI</h3>
                    <div class="form-group">
                        <label>URL Backend</label>
                        <input type="text" id="backend-url" value="https://surfai-backend-production.up.railway.app" placeholder="https://surfai-backend-production.up.railway.app">
                    </div>
                    <div class="form-group">
                        <label>Cl√© API (optionnelle)</label>
                        <input type="password" id="backend-api-key" placeholder="Cl√© API pour routes prot√©g√©es">
                    </div>
                    <button class="button" onclick="testBackendConnection()">üîç Tester connexion</button>
                </div>
                
                <div class="card">
                    <h3>üóÑÔ∏è Configuration Supabase</h3>
                    <div class="form-group">
                        <label>URL Supabase</label>
                        <input type="text" id="supabase-url" placeholder="https://votre-projet.supabase.co">
                    </div>
                    <div class="form-group">
                        <label>Cl√© Anon Supabase</label>
                        <input type="password" id="supabase-key" placeholder="votre-cle-anon">
                    </div>
                    <button class="button" onclick="testSupabaseConnection()">üîç Tester connexion Supabase</button>
                </div>
                
                <div class="card">
                    <h3>üìä √âtat de l'application</h3>
                    <div id="app-status">
                        <p>üî¥ Backend: Non test√©</p>
                        <p>üî¥ IA Engine: Non v√©rifi√©</p>
                        <p>üî¥ Supabase: Non configur√©</p>
                        <p>üî¥ Donn√©es: Non charg√©es</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ========================================
        // GESTIONNAIRE CENTRALIS√â DE DONN√âES SURFAI
        // ========================================

        class SurfAIDataManager {
            constructor(backendUrl, supabaseClient = null) {
                this.backendUrl = backendUrl;
                this.supabase = supabaseClient;
                this.cache = {
                    weatherData: new Map(),
                    aiPreferences: null,
                    userprofiles: null,
                    spots: null,
                    boards: null,
                    lastUpdate: new Map()
                };
                this.subscribers = new Map();
                this.weatherCacheTimeout = 30 * 60 * 1000; // 30 min
                this.staticCacheTimeout = 24 * 60 * 60 * 1000; // 24h
                this.currentUserId = '3ba8ad73-e2c6-4971-8b32-5a123456789a';
            }
            parsePostgreSQLArray(pgArray) {
                if (!pgArray) return null;
                if (Array.isArray(pgArray)) return pgArray;
                
                return pgArray.toString()
                    .replace(/[{}]/g, '')
                    .split(',')
                    .map(item => item.trim())
                    .filter(item => item.length > 0);
            }
            // GESTION SPOTS
            async getSpots() {
                if (this.cache.spots && this.isCacheValid('spots', this.staticCacheTimeout)) {
                    return this.cache.spots;
                }

                if (this.supabase) {
                    try {
                        const { data: spots, error } = await this.supabase
                            .from('spots')
                            .select('*')
                            .order('country, region, city, name');

                        if (error) throw error;
                        const hierarchy = this.buildSpotHierarchy(spots);
                        this.cache.spots = hierarchy;
                        this.cache.lastUpdate.set('spots', Date.now());
                        return hierarchy;
                    } catch (error) {
                        console.warn('Erreur Supabase spots, fallback:', error);
                    }
                }

                // Fallback spots par d√©faut
                const defaultSpots = this.getFallbackSpots();
                this.cache.spots = defaultSpots;
                return defaultSpots;
            }

            buildSpotHierarchy(spots) {
                const hierarchy = {};
                spots.forEach(spot => {
                    if (!hierarchy[spot.country]) hierarchy[spot.country] = {};
                    if (!hierarchy[spot.country][spot.region]) hierarchy[spot.country][spot.region] = {};
                    if (!hierarchy[spot.country][spot.region][spot.city]) hierarchy[spot.country][spot.region][spot.city] = [];
                    
                    hierarchy[spot.country][spot.region][spot.city].push({
                        id: spot.id,
                        name: spot.name,
                        coords: { lat: spot.lat, lng: spot.lng },
                        type: spot.bottom_type || 'sand',
                        idealWind: this.parsePostgreSQLArray(spot.ideal_wind),
                        idealSwell: this.parsePostgreSQLArray(spot.ideal_swell),
                        idealTide: this.parsePostgreSQLArray(spot.ideal_tide),
                        isFavorite: false
                    });
                });
                return hierarchy;
            }

            async getSpotsByLevel(country = null, region = null, city = null) {
                const hierarchy = await this.getSpots();
                if (!country) return Object.keys(hierarchy);
                if (!region) return Object.keys(hierarchy[country] || {});
                if (!city) return Object.keys(hierarchy[country]?.[region] || {});
                return hierarchy[country]?.[region]?.[city] || [];
            }

            async findSpotById(spotId) {
                const hierarchy = await this.getSpots();
                for (const country of Object.values(hierarchy)) {
                    for (const region of Object.values(country)) {
                        for (const city of Object.values(region)) {
                            const spot = city.find(s => s.id === spotId);
                            if (spot) return spot;
                        }
                    }
                }
                return null;
            }

            // GESTION M√âT√âO
            async getWeatherData(spotId, forceRefresh = false) {
                const cacheKey = `weather_${spotId}`;
                
                if (!forceRefresh && this.cache.weatherData.has(spotId)) {
                    const cached = this.cache.weatherData.get(spotId);
                    if (this.isCacheValid(cacheKey, this.weatherCacheTimeout)) {
                        return cached;
                    }
                }

                try {
                    const spot = await this.findSpotById(spotId);
                    const spotName = spot ? spot.name : spotId;
                    
                    const weatherData = await this.fetchFromBackend(`/api/v1/sessions/weather/auto?spot=${spotName}`);
                    
                    if (weatherData.success) {
                        const processedData = this.processWeatherData(weatherData.weather, spot);
                        this.cache.weatherData.set(spotId, processedData);
                        this.cache.lastUpdate.set(cacheKey, Date.now());
                        
                        if (this.supabase) {
                            await this.cacheWeatherInSupabase(spotId, processedData);
                        }
                        
                        return processedData;
                    }
                } catch (error) {
                    console.warn('Backend m√©t√©o indisponible:', error);
                }

                return this.getDefaultWeatherData();
            }

            async cacheWeatherInSupabase(spotId, weatherData) {
                if (!this.supabase) return;
                try {
                    await this.supabase
                        .from('weather_cache')
                        .upsert({
                            spot_id: spotId,
                            timestamp: new Date(),
                            wave_height: weatherData.waveHeight,
                            wave_period: weatherData.wavePeriod,
                            wind_speed: weatherData.windSpeed,
                            wind_direction: weatherData.windDirection,
                            tide: weatherData.tide,
                            water_temp: weatherData.waterTemp,
                            confidence: weatherData.confidence
                        });
                } catch (error) {
                    console.warn('Erreur cache m√©t√©o Supabase:', error);
                }
            }

            // GESTION PROFIL & BOARDS
            async getUserProfile(userId) {
                if (this.cache.userprofiles && this.isCacheValid('profiles', this.staticCacheTimeout)) {
                    return this.cache.userprofiles;
                }

                if (this.supabase) {
                    try {
                        const { data: profiles, error } = await this.supabase
                            .from('profiles')
                            .select('*')
                            .eq('id', userId)
                            .single();

                        if (error && error.code !== 'PGRST116') throw error;
                        this.cache.userprofiles = profiles || this.getDefaultprofiles();
                        this.cache.lastUpdate.set('profiles', Date.now());
                        return this.cache.userprofiles;
                    } catch (error) {
                        console.warn('Erreur profil Supabase:', error);
                    }
                }

                return this.getDefaultprofiles();
            }

            async getUserBoards(userId) {
                if (this.cache.boards && this.isCacheValid('boards', this.staticCacheTimeout)) {
                    return this.cache.boards;
                }

                if (this.supabase) {
                    try {
                        const { data: boards, error } = await this.supabase
                            .from('boards')
                            .select('*')
                            .eq('id', userId)
                            .order('created_at', { ascending: false });

                        if (error) throw error;
                        this.cache.boards = boards || [];
                        this.cache.lastUpdate.set('boards', Date.now());
                        return this.cache.boards;
                    } catch (error) {
                        console.warn('Erreur boards Supabase:', error);
                    }
                }

                // Fallback localStorage
                const localBoards = JSON.parse(localStorage.getItem('surfai_boards') || '[]');
                this.cache.boards = localBoards;
                return localBoards;
            }

            async saveUserBoard(userId, board) {
                if (this.supabase) {
                    try {
                        const { data, error } = await this.supabase
                            .from('boards')
                            .insert([{
                                user_id: userId,
                                name: board.name,
                                size: board.size,
                                type: board.type,
                                shaper: board.shaper
                            }])
                            .select();

                        if (error) throw error;
                        this.cache.boards = null;
                        return data;
                    } catch (error) {
                        console.warn('Erreur sauvegarde board Supabase:', error);
                    }
                }

                // Fallback localStorage
                const boards = JSON.parse(localStorage.getItem('surfai_boards') || '[]');
                const newBoard = { ...board, id: Date.now() };
                boards.push(newBoard);
                localStorage.setItem('surfai_boards', JSON.stringify(boards));
                this.cache.boards = null;
                return [newBoard];
            }

            // PR√âDICTIONS PERSONNALIS√âES
            async getPersonalizedPrediction(userId, spotId, boardId = null) {
                try {
                    const [weatherData, aiPreferences, profiles, boards] = await Promise.all([
                        this.getWeatherData(spotId),
                        this.getAIPreferences(userId),
                        this.getUserProfile(userId),
                        this.getUserBoards(userId)
                    ]);

                    const selectedBoard = boardId ? boards.find(b => b.id == boardId) : null;
                    const score = this.calculatePersonalizedScore(weatherData, aiPreferences, profiles, selectedBoard);

                    return {
                        spotId,
                        boardId,
                        weather: weatherData,
                        score: score,
                        recommendation: this.generateRecommendation(score, weatherData, profiles),
                        timestamp: new Date().toISOString()
                    };
                } catch (error) {
                    console.error('Erreur pr√©diction personnalis√©e:', error);
                    throw error;
                }
            }

            calculatePersonalizedScore(weather, aiPrefs, profiles, board) {
                let score = 5.0;
                
                // Facteur conditions m√©t√©o (40%)
                if (aiPrefs && aiPrefs.wavePreferences) {
                    const waveOptimal = aiPrefs.wavePreferences.optimalHeight.value;
                    const waveDiff = Math.abs(weather.waveHeight - waveOptimal);
                    score -= waveDiff * 1.5;
                }
                
                if (aiPrefs && aiPrefs.windPreferences) {
                    const windOptimal = aiPrefs.windPreferences.optimalSpeed.value;
                    const windDiff = Math.abs(weather.windSpeed - windOptimal);
                    score -= windDiff * 0.08;
                }

                // Facteur niveau utilisateur (30%)
                const levelFactor = this.getLevelFactor(profiles.level, weather);
                score *= levelFactor;

                // Facteur board adapt√©e (20%)
                if (board) {
                    const boardFactor = this.getBoardFactor(board, weather, profiles);
                    score *= boardFactor;
                }

                // Facteur confiance donn√©es (10%)
                score *= (weather.confidence || 0.7);

                return Math.max(1, Math.min(10, score));
            }

            getBoardFactor(board, weather, profiles) {
                let factor = 1.0;
                
                const boardAdaptation = {
                    'longboard': { minWave: 0.3, maxWave: 1.5, skillBonus: 0.1 },
                    'shortboard': { minWave: 1.0, maxWave: 4.0, skillPenalty: 0.2 },
                    'fish': { minWave: 0.5, maxWave: 2.0, speedBonus: 0.15 },
                    'midlength': { minWave: 0.6, maxWave: 2.5, versatile: 0.1 }
                };

                const adaptation = boardAdaptation[board.type];
                if (adaptation) {
                    if (weather.waveHeight >= adaptation.minWave && weather.waveHeight <= adaptation.maxWave) {
                        factor += 0.1;
                    }
                    
                    if (adaptation.skillBonus && profiles.level === 'beginner') {
                        factor += adaptation.skillBonus;
                    }
                    
                    if (adaptation.skillPenalty && profiles.level === 'beginner') {
                        factor -= adaptation.skillPenalty;
                    }
                }
                
                return Math.max(0.7, Math.min(1.3, factor));
            }

            // UTILITAIRES
            async fetchFromBackend(endpoint, options = {}) {
                const url = `${this.backendUrl}${endpoint}`;
                const response = await fetch(url, {
                    headers: { 'Content-Type': 'application/json' },
                    ...options
                });
                return await response.json();
            }

            async getAIPreferences(userId) {
                if (this.cache.aiPreferences && this.isCacheValid('ai_prefs', this.weatherCacheTimeout)) {
                    return this.cache.aiPreferences;
                }

                try {
                    const data = await this.fetchFromBackend(`/api/v1/ai/demo/${userId}`);
                    this.cache.aiPreferences = data.userPreferences;
                    this.cache.lastUpdate.set('ai_prefs', Date.now());
                    return this.cache.aiPreferences;
                } catch (error) {
                    console.warn('Erreur pr√©f√©rences IA:', error);
                    return null;
                }
            }

            isCacheValid(key, timeout) {
                const lastUpdate = this.cache.lastUpdate.get(key);
                return lastUpdate && (Date.now() - lastUpdate) < timeout;
            }

            processWeatherData(raw, spot) {
                return {
                    waveHeight: raw.waveHeight || 0,
                    wavePeriod: raw.wavePeriod || 10,
                    windSpeed: raw.windSpeed || 10,
                    windDirection: raw.windDirection || 'N',
                    tide: raw.tide || 'mid',
                    waterTemp: raw.waterTemp || 15,
                    confidence: raw.confidence || 0.7,
                    timestamp: new Date().toISOString(),
                    source: 'backend',
                    spot: spot
                };
            }

            getFallbackSpots() {
                return {
                    'France': {
                        'Nouvelle-Aquitaine': {
                            'Biarritz': [
                                { id: 'biarritz-grande-plage', name: 'Grande Plage', coords: { lat: 43.4832, lng: -1.5586 }, type: 'beach_break', difficulty: 'beginner' },
                                { id: 'biarritz-miramar', name: 'Miramar', coords: { lat: 43.4825, lng: -1.5595 }, type: 'beach_break', difficulty: 'intermediate' },
                                { id: 'biarritz-cote-basques', name: 'C√¥te des Basques', coords: { lat: 43.4821, lng: -1.5601 }, type: 'reef_break', difficulty: 'intermediate' }
                            ],
                            'Anglet': [
                                { id: 'anglet-chambre-amour', name: 'Chambre d\'Amour', coords: { lat: 43.5156, lng: -1.5267 }, type: 'beach_break', difficulty: 'intermediate' },
                                { id: 'anglet-les-cavaliers', name: 'Les Cavaliers', coords: { lat: 43.5134, lng: -1.5278 }, type: 'beach_break', difficulty: 'beginner' }
                            ],
                            'Hossegor': [
                                { id: 'hossegor-la-nord', name: 'La Nord', coords: { lat: 43.6619, lng: -1.4022 }, type: 'beach_break', difficulty: 'expert' },
                                { id: 'hossegor-la-centrale', name: 'La Centrale', coords: { lat: 43.6615, lng: -1.4018 }, type: 'beach_break', difficulty: 'advanced' }
                            ]
                        }
                    }
                };
            }

            getDefaultWeatherData() {
                return {
                    waveHeight: 1.0,
                    wavePeriod: 10,
                    windSpeed: 15,
                    windDirection: 'W',
                    tide: 'mid',
                    waterTemp: 15,
                    confidence: 0.5,
                    source: 'default'
                };
            }

            getDefaultprofiles() {
                return {
                    level: 'intermediate',
                    preferences: { waveMin: 0.8, waveMax: 2.5 }
                };
            }

            getLevelFactor(level, weather) {
                const factors = {
                    'beginner': weather.waveHeight > 1.5 ? 0.7 : 1.1,
                    'intermediate': 1.0,
                    'advanced': weather.waveHeight < 1.0 ? 0.9 : 1.1,
                    'expert': weather.waveHeight < 1.5 ? 0.8 : 1.2
                };
                return factors[level] || 1.0;
            }

            generateRecommendation(score, weather, profiles) {
                if (score >= 8) return "Session PARFAITE pour vous ! Conditions id√©ales selon votre profil.";
                if (score >= 7) return "Excellente session en perspective ! Tr√®s proche de vos pr√©f√©rences.";
                if (score >= 6) return "Bonne session possible. Conditions favorables.";
                if (score >= 5) return "Session correcte mais pas optimale pour votre niveau.";
                return "Conditions peu favorables selon votre profil.";
            }
        }

        // ========================================
        // VARIABLES GLOBALES ET INITIALISATION
        // ========================================
        let backendUrl = 'https://surfai-backend-production.up.railway.app';
        let backendApiKey = null;
        let supabaseClient = null;
        let dataManager = null;
        let userData = {
            sessions: [],
            spots: [],
            favoriteSpots: [],
            predictions: [],
            profiles: {},
            boards: []
        };

        document.addEventListener('DOMContentLoaded', async function() {
            // D√©finir la date d'aujourd'hui par d√©faut
            document.getElementById('session-date').value = new Date().toISOString().split('T')[0];
            
            // Charger config sauvegard√©e
            const savedBackendUrl = localStorage.getItem('backend_url');
            const savedApiKey = localStorage.getItem('backend_api_key');
            const savedSupabaseUrl = localStorage.getItem('supabase_url');
            const savedSupabaseKey = localStorage.getItem('supabase_key');
            
            if (savedBackendUrl) {
                backendUrl = savedBackendUrl;
                document.getElementById('backend-url').value = savedBackendUrl;
            }
            if (savedApiKey) {
                backendApiKey = savedApiKey;
                document.getElementById('backend-api-key').value = savedApiKey;
            }
            if (savedSupabaseUrl) document.getElementById('supabase-url').value = savedSupabaseUrl;
            if (savedSupabaseKey) document.getElementById('supabase-key').value = savedSupabaseKey;

            // Initialiser gestionnaire centralis√© SANS Supabase d'abord
            dataManager = new SurfAIDataManager(backendUrl, null);
            
            // Connecter Supabase et r√©initialiser dataManager
            if (supabaseAuth) {
                dataManager.supabase = supabaseAuth;
                dataManager.currentUserId = '3ba8ad73-e2c6-4971-8b32-5a123456789a';
                console.log('DataManager connect√© avec supabaseAuth');
            }
            
            console.log('Gestionnaire centralis√© initialis√©');
            
            // Test auto du backend
            await checkBackendConnection();
            
            // Charger donn√©es harmonis√©es
            await loadHarmonizedData();
            
            // Charger recommandations intelligentes
            await generateIntelligentRecommendations();
        });

        // ========================================
        // CHARGEMENT DONN√âES HARMONIS√âES
        // ========================================
        
        async function loadHarmonizedData() {
            try {
                // Charger spots hi√©rarchiques
                await loadSpotsHierarchy();
                
                // Charger boards utilisateur
                await loadUserBoards();
                
                // Charger profil
                await loadprofiles();

                // Charger aussi les favoris
                await loadFavoriteSpots();
                
                console.log('Donn√©es harmonis√©es charg√©es');
            } catch (error) {
                console.error('Erreur chargement donn√©es harmonis√©es:', error);
            }
        }

        async function loadSpotsHierarchy() {
            try {
                const spots = await dataManager.getSpots();
                
                // Peupler tous les s√©lecteurs de pays
                const countrySelectors = ['session-country', 'spots-country', 'forecast-country'];
                const countries = Object.keys(spots);
                
                countrySelectors.forEach(selectorId => {
                    const select = document.getElementById(selectorId);
                    if (select) {
                        select.innerHTML = '<option value="">S√©lectionnez un pays</option>';
                        countries.forEach(country => {
                            select.innerHTML += `<option value="${country}">${country}</option>`;
                        });
                    }
                });
                 
            } catch (error) {
                console.error('Erreur chargement spots:', error);
            }
        }

        async function loadUserBoards() {
            try {
                const boards = await dataManager.getUserBoards(dataManager.currentUserId);
                
                // Peupler s√©lecteurs de boards
                const boardSelectors = ['session-board', 'forecast-board'];
                
                boardSelectors.forEach(selectorId => {
                    const select = document.getElementById(selectorId);
                    if (select) {
                        select.innerHTML = '<option value="">Aucune board</option>';
                        boards.forEach(board => {
                            select.innerHTML += `<option value="${board.id}">${board.name} (${board.size})</option>`;
                        });
                    }
                });
                
                // Mettre √† jour userData pour compatibilit√©
                userData.boards = boards;
                
            } catch (error) {
                console.error('Erreur chargement boards:', error);
            }
        }

        // ========================================
        // NAVIGATION HI√âRARCHIQUE SPOTS
        // ========================================
        
        async function updateRegions() {
            const country = document.getElementById('session-country').value;
            const regionSelect = document.getElementById('session-region');
            const citySelect = document.getElementById('session-city');
            const spotSelect = document.getElementById('session-spot');
            
            // Reset s√©lecteurs suivants
            regionSelect.innerHTML = '<option value="">S√©lectionnez une r√©gion</option>';
            citySelect.innerHTML = '<option value="">S√©lectionnez une ville</option>';
            spotSelect.innerHTML = '<option value="">S√©lectionnez un spot</option>';
            
            if (!country) return;
            
            try {
                const regions = await dataManager.getSpotsByLevel(country);
                regions.forEach(region => {
                    regionSelect.innerHTML += `<option value="${region}">${region}</option>`;
                });
            } catch (error) {
                console.error('Erreur mise √† jour r√©gions:', error);
            }
        }

        async function updateCities() {
            const country = document.getElementById('session-country').value;
            const region = document.getElementById('session-region').value;
            const citySelect = document.getElementById('session-city');
            const spotSelect = document.getElementById('session-spot');
            
            citySelect.innerHTML = '<option value="">S√©lectionnez une ville</option>';
            spotSelect.innerHTML = '<option value="">S√©lectionnez un spot</option>';
            
            if (!country || !region) return;
            
            try {
                const cities = await dataManager.getSpotsByLevel(country, region);
                cities.forEach(city => {
                    citySelect.innerHTML += `<option value="${city}">${city}</option>`;
                });
            } catch (error) {
                console.error('Erreur mise √† jour villes:', error);
            }
        }

        async function updateSpots() {
            const country = document.getElementById('session-country').value;
            const region = document.getElementById('session-region').value;
            const city = document.getElementById('session-city').value;
            const spotSelect = document.getElementById('session-spot');
            
            spotSelect.innerHTML = '<option value="">S√©lectionnez un spot</option>';
            
            if (!country || !region || !city) return;
            
            try {
                const spots = await dataManager.getSpotsByLevel(country, region, city);
                spots.forEach(spot => {
                    spotSelect.innerHTML += `<option value="${spot.id}">${spot.name}</option>`;
                });
            } catch (error) {
                console.error('Erreur mise √† jour spots:', error);
            }
        }

        // Navigation m√©t√©o (m√™me logique)
        async function updateForecastRegions() {
            const country = document.getElementById('forecast-country').value;
            const regionSelect = document.getElementById('forecast-region');
            const citySelect = document.getElementById('forecast-city');
            const spotSelect = document.getElementById('forecast-spot');
            
            regionSelect.innerHTML = '<option value="">S√©lectionnez une r√©gion</option>';
            citySelect.innerHTML = '<option value="">S√©lectionnez une ville</option>';
            spotSelect.innerHTML = '<option value="">S√©lectionnez un spot</option>';
            
            if (!country) return;
            
            try {
                const regions = await dataManager.getSpotsByLevel(country);
                regions.forEach(region => {
                    regionSelect.innerHTML += `<option value="${region}">${region}</option>`;
                });
            } catch (error) {
                console.error('Erreur forecast r√©gions:', error);
            }
        }

        async function updateForecastCities() {
            const country = document.getElementById('forecast-country').value;
            const region = document.getElementById('forecast-region').value;
            const citySelect = document.getElementById('forecast-city');
            const spotSelect = document.getElementById('forecast-spot');
            
            citySelect.innerHTML = '<option value="">S√©lectionnez une ville</option>';
            spotSelect.innerHTML = '<option value="">S√©lectionnez un spot</option>';
            
            if (!country || !region) return;
            
            try {
                const cities = await dataManager.getSpotsByLevel(country, region);
                cities.forEach(city => {
                    citySelect.innerHTML += `<option value="${city}">${city}</option>`;
                });
            } catch (error) {
                console.error('Erreur forecast villes:', error);
            }
        }

        async function updateForecastSpots() {
            const country = document.getElementById('forecast-country').value;
            const region = document.getElementById('forecast-region').value;
            const city = document.getElementById('forecast-city').value;
            const spotSelect = document.getElementById('forecast-spot');
            
            spotSelect.innerHTML = '<option value="">S√©lectionnez un spot</option>';
            
            if (!country || !region || !city) return;
            
            try {
                const spots = await dataManager.getSpotsByLevel(country, region, city);
                spots.forEach(spot => {
                    spotSelect.innerHTML += `<option value="${spot.id}">${spot.name}</option>`;
                });
            } catch (error) {
                console.error('Erreur forecast spots:', error);
            }
        }

       // Navigation spots onglet
async function updateSpotsNavigation() {
    const country = document.getElementById('spots-country').value;
    const region = document.getElementById('spots-region').value;
    const city = document.getElementById('spots-city').value;
    
    try {
        const spots = await dataManager.getSpots();
        
        // Mettre √† jour le menu R√©gion si un pays est s√©lectionn√©
        if (country && country !== "") {
            const regionSelect = document.getElementById('spots-region');
            regionSelect.innerHTML = '<option value="">Toutes les r√©gions</option>';
            
            if (spots[country]) {
                Object.keys(spots[country]).forEach(regionName => {
                    regionSelect.innerHTML += `<option value="${regionName}">${regionName}</option>`;
                });
                // Restaurer la s√©lection actuelle si elle existe encore
                if (region && spots[country][region]) {
                    regionSelect.value = region;
                }
            }
        }
        
        // Mettre √† jour le menu Ville si une r√©gion est s√©lectionn√©e
        if (country && region && country !== "" && region !== "") {
            const citySelect = document.getElementById('spots-city');
            citySelect.innerHTML = '<option value="">Toutes les villes</option>';
            
            if (spots[country] && spots[country][region]) {
                Object.keys(spots[country][region]).forEach(cityName => {
                    citySelect.innerHTML += `<option value="${cityName}">${cityName}</option>`;
                });
                // Restaurer la s√©lection actuelle si elle existe encore
                if (city && spots[country][region][city]) {
                    citySelect.value = city;
                }
            }
        }
        
        // Filtrer l'affichage des spots
        displayFilteredSpots(spots, country, region, city);
        
    } catch (error) {
        console.error('Erreur navigation spots:', error);
    }
}

function displayAllSpots(spotsHierarchy) {
    const allSpotsList = document.getElementById('all-spots-list');
    let html = '';
    
    Object.entries(spotsHierarchy).forEach(([country, regions]) => {
        Object.entries(regions).forEach(([region, cities]) => {
            Object.entries(cities).forEach(([city, spots]) => {
                spots.forEach(spot => {
                    html += `
                        <div class="card">
                            <h4>üèÑ‚Äç‚ôÇÔ∏è ${spot.name}</h4>
                            <p>üìç ${city}, ${region}, ${country}</p>
                            <p style="font-size: 0.9rem; color: #666;">
                                üèñÔ∏è ${spot.type} ‚Ä¢ üí® Vent: ${spot.idealWind && spot.idealWind.length > 0 ? spot.idealWind.join('/') : 'Variable'} ‚Ä¢ üåä Houle: ${spot.idealSwell && spot.idealSwell.length > 0 ? spot.idealSwell.join('/') : 'Variable'} ‚Ä¢ üåä Mar√©e: ${spot.idealTide && spot.idealTide.length > 0 ? spot.idealTide.join('/') : 'Variable'}
                            </p>
                            <div style="margin-top: 8px;">
                                <button onclick="toggleFavorite('${spot.id}')" class="button secondary" style="padding: 4px 8px; font-size: 0.8rem;">
                                    ‚≠ê Ajouter aux favoris
                                </button>
                            </div>
                        </div>
                    `;
                });
            });
        });
    });
    
    allSpotsList.innerHTML = html;
}

function displayFilteredSpots(spotsHierarchy, filterCountry, filterRegion, filterCity) {
    const allSpotsList = document.getElementById('all-spots-list');
    let html = '';
    
    Object.entries(spotsHierarchy).forEach(([country, regions]) => {
        if (filterCountry && country !== filterCountry) return;
        
        Object.entries(regions).forEach(([region, cities]) => {
            if (filterRegion && region !== filterRegion) return;
            
            Object.entries(cities).forEach(([city, spots]) => {
                if (filterCity && city !== filterCity) return;
                
                spots.forEach(spot => {
                    html += `
                        <div class="card">
                            <h4>üèÑ‚Äç‚ôÇÔ∏è ${spot.name}</h4>
                            <p>üìç ${city}, ${region}, ${country}</p>
                            <p style="font-size: 0.9rem; color: #666;">
                                üèñÔ∏è ${spot.type} ‚Ä¢ üí® Vent: ${spot.idealWind && spot.idealWind.length > 0 ? spot.idealWind.join('/') : 'Variable'} ‚Ä¢ üåä Houle: ${spot.idealSwell && spot.idealSwell.length > 0 ? spot.idealSwell.join('/') : 'Variable'} ‚Ä¢ üåä Mar√©e: ${spot.idealTide && spot.idealTide.length > 0 ? spot.idealTide.join('/') : 'Variable'}
                            </p>
                            <div style="margin-top: 8px;">
                                <button onclick="toggleFavorite('${spot.id}')" class="button secondary" style="padding: 4px 8px; font-size: 0.8rem;">
                                    ‚≠ê Ajouter aux favoris
                                </button>
                            </div>
                        </div>
                    `;
                });
            });
        });
    });
    
    allSpotsList.innerHTML = html || '<div class="card"><p>Aucun spot trouv√© pour ces crit√®res.</p></div>';
}

function displayFilteredSpots(spotsHierarchy, filterCountry, filterRegion, filterCity) {
    const allSpotsList = document.getElementById('all-spots-list');
    let html = '';
    
    Object.entries(spotsHierarchy).forEach(([country, regions]) => {
        if (filterCountry && country !== filterCountry) return;
        
        Object.entries(regions).forEach(([region, cities]) => {
            if (filterRegion && region !== filterRegion) return;
            
            Object.entries(cities).forEach(([city, spots]) => {
                if (filterCity && city !== filterCity) return;
                
                spots.forEach(spot => {
                    html += `
                        <div class="card">
                            <h4>üèÑ‚Äç‚ôÇÔ∏è ${spot.name}</h4>
                            <p>üìç ${city}, ${region}, ${country}</p>
                            <p style="font-size: 0.9rem; color: #666;">
                                üèñÔ∏è ${spot.type} ‚Ä¢ üí® Vent: ${spot.idealWind && spot.idealWind.length > 0 ? spot.idealWind.join('/') : 'Variable'} ‚Ä¢ üåä Houle: ${spot.idealSwell && spot.idealSwell.length > 0 ? spot.idealSwell.join('/') : 'Variable'} ‚Ä¢ üåä Mar√©e: ${spot.idealTide && spot.idealTide.length > 0 ? spot.idealTide.join('/') : 'Variable'}
                            </p>
                            <div style="margin-top: 8px;">
                                <button onclick="toggleFavorite('${spot.id}')" class="button secondary" style="padding: 4px 8px; font-size: 0.8rem;">
                                    ‚≠ê Ajouter aux favoris
                                </button>
                            </div>
                        </div>
                    `;
                });
            });
        });
    });
    
    allSpotsList.innerHTML = html || '<div class="card"><p>Aucun spot trouv√© pour ces crit√®res.</p></div>';
}

        // ========================================
        // FONCTIONS M√âT√âO HARMONIS√âES
        // ========================================
        
        async function getIntelligentForecast() {
            const spotId = document.getElementById('forecast-spot').value;
            const level = document.getElementById('forecast-level').value;
            const boardId = document.getElementById('forecast-board').value;
            const forecastGrid = document.getElementById('forecast-grid');
            
            if (!spotId) {
                showMessage('error', 'Veuillez s√©lectionner un spot');
                return;
            }
            
            forecastGrid.innerHTML = '<div class="loading">üåä R√©cup√©ration pr√©dictions harmonis√©es...</div>';
            
            try {
                // Utiliser gestionnaire centralis√© pour pr√©diction personnalis√©e
                const prediction = await dataManager.getPersonalizedPrediction(
                    dataManager.currentUserId, 
                    spotId, 
                    boardId
                );
                
                displayPersonalizedForecast(prediction, level);
                
            } catch (error) {
                console.error('Erreur pr√©visions harmonis√©es:', error);
                forecastGrid.innerHTML = `
                    <div class="error">
                        ‚ùå Erreur: ${error.message}<br>
                        Impossible de r√©cup√©rer les pr√©visions personnalis√©es.
                    </div>
                `;
            }
        }

        function displayPersonalizedForecast(prediction, level) {
            const forecastGrid = document.getElementById('forecast-grid');
            const weather = prediction.weather;
            const score = prediction.score;
            
            let cardClass = 'forecast-card';
            let scoreClass = 'forecast-score';
            
            if (score >= 8) {
                cardClass += ' excellent';
                scoreClass += ' excellent';
            } else if (score >= 6) {
                cardClass += ' good';  
                scoreClass += ' good';
            } else {
                cardClass += ' average';
                scoreClass += ' average';
            }
            
            const spot = document.getElementById('forecast-spot').selectedOptions[0]?.text || 'Spot s√©lectionn√©';
            const board = document.getElementById('forecast-board').selectedOptions[0]?.text || 'Aucune board';
            
            forecastGrid.innerHTML = `
                <div class="card" style="margin-bottom: 15px; background: linear-gradient(45deg, #f0fff4, #ffffff); border-left: 4px solid #48bb78;">
                    <h4>üß† Pr√©diction IA Personnalis√©e Harmonis√©e</h4>
                    <p><strong>Analyse bas√©e sur vos pr√©f√©rences IA + board + niveau</strong></p>
                </div>
                
                <div class="${cardClass}">
                    <div class="forecast-header">
                        <span class="forecast-date">üìç ${spot} - Maintenant</span>
                        <span class="${scoreClass}">${score.toFixed(1)}/10</span>
                    </div>
                    
                    <div class="forecast-conditions">
                        <div class="condition">üåä ${weather.waveHeight.toFixed(1)}m</div>
                        <div class="condition">‚è±Ô∏è ${weather.wavePeriod.toFixed(1)}s</div>
                        <div class="condition">üí® ${Math.round(weather.windSpeed)}km/h</div>
                        <div class="condition">üß≠ ${weather.windDirection}</div>
                        <div class="condition">üåä ${weather.tide}</div>
                        <div class="condition">üå°Ô∏è ${weather.waterTemp.toFixed(1)}¬∞C</div>
                    </div>
                    
                    <div class="prediction-info">
                        <div class="prediction-recommendation">
                            ${prediction.recommendation}
                        </div>
                        <div style="margin-top: 8px; font-size: 0.8rem; color: #666;">
                            <strong>Board:</strong> ${board}<br>
                            <strong>Niveau:</strong> ${level} ‚Ä¢ <strong>Confiance:</strong> ${Math.round(weather.confidence * 100)}%
                        </div>
                    </div>
                </div>
                
                <div class="card" style="background: #f8fafc; margin-top: 15px;">
                    <h4>üéØ Facteurs pris en compte</h4>
                    <ul style="margin-left: 20px; font-size: 0.9rem;">
                        <li>‚úÖ Vos pr√©f√©rences IA apprises</li>
                        <li>‚úÖ Adaptation board s√©lectionn√©e</li>
                        <li>‚úÖ Votre niveau de surf</li>
                        <li>‚úÖ Conditions m√©t√©o temps r√©el</li>
                    </ul>
                </div>
            `;
        }

        // Fonction pour g√©rer les spots favoris
        async function toggleFavorite(spotId) {
    try {
        const { data, error } = await dataManager.supabase.rpc('toggle_favorite', {
            p_user_id: dataManager.currentUserId,
            p_spot_id: spotId
        });
        
        if (error) {
            console.error('Erreur:', error);
            alert('Erreur: ' + error.message);
        } else {
            console.log('Succ√®s:', data);
            const message = data === 'removed' ? 'Spot retir√© des favoris !' : 'Spot ajout√© aux favoris !';
            alert(message);
            
            // Recharger l'affichage des favoris
            await loadFavoriteSpots();
        }
        
    } catch (err) {
        console.error('Erreur catch:', err);
        alert('Erreur: ' + err.message);
    }
}
        
        // Fonction pour charger les spots favoris
            async function loadFavoriteSpots() {
        if (!dataManager.supabase) return;
        
        try {
            const userId = dataManager.currentUserId;
            
            // R√©cup√©rer juste les favoris
            const { data: favorites, error } = await dataManager.supabase
                .from('favorite_spots')
                .select('spot_id')
                .eq('id', userId)
            
            if (error) throw error;
            
            if (spots.length === 0) {
                displayFavoriteSpots([]);
                return;
            }
            
            // R√©cup√©rer les d√©tails des spots s√©par√©ment
            const spotIds = favorites.map(f => f.spot_id);
            const { data: spotsData, error: spotsError } = await dataManager.supabase
                .from('spots')
                .select('*')
                .in('id', spotIds);
            
            if (spotsError) throw spotsError;
            
            displayFavoriteSpots(spotsData || []);
            
        } catch (error) {
            console.error('Erreur chargement favoris:', error);
            document.getElementById('favorite-spots-list').innerHTML = `
                <div class="card">
                    <p>Erreur chargement favoris: ${error.message}</p>
                </div>
            `;
        }
    }

        // Fonction pour afficher les spots favoris
        function displayFavoriteSpots(spots) {
    const favoritesList = document.getElementById('favorite-spots-list');
    
    if (spots.length === 0) {  // <-- Chang√© ici
        favoritesList.innerHTML = `
            <div class="card">
                <h4>‚≠ê Vos spots favoris</h4>
                <p>Aucun spot favori pour le moment. Ajoutez vos spots pr√©f√©r√©s depuis la liste ci-dessous !</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="card"><h4>‚≠ê Vos spots favoris</h4></div>';
    
    spots.forEach(spot => {  // <-- Chang√© ici aussi
        if (spot) {
            html += `
                <div class="card" style="border-left: 4px solid #48bb78;">
                    <h4>üèÑ‚Äç‚ôÇÔ∏è ${spot.name}</h4>
                    <p>üìç ${spot.city}, ${spot.region}, ${spot.country}</p>
                    <p style="font-size: 0.9rem; color: #666;">
                        üèñÔ∏è ${spot.bottom_type} ‚Ä¢ üí® Vent: ${Array.isArray(spot.ideal_wind) && spot.ideal_wind.length > 0 ? spot.ideal_wind.join('/') : 'Variable'} ‚Ä¢ üåä Houle: ${Array.isArray(spot.ideal_swell) && spot.ideal_swell.length > 0 ? spot.ideal_swell.join('/') : 'Variable'} ‚Ä¢ üåä Mar√©e: ${Array.isArray(spot.ideal_tide) && spot.ideal_tide.length > 0 ? spot.ideal_tide.join('/') : 'Variable'}
                    </p>
                    <div style="margin-top: 8px;">
                        <button onclick="toggleFavorite('${spot.id}')" class="button secondary" style="padding: 4px 8px; font-size: 0.8rem; background: #f56565; color: white;">
                            ‚ùå Retirer
                        </button>
                        <button onclick="viewSpotForecast('${spot.id}')" class="button" style="padding: 4px 8px; font-size: 0.8rem;">
                            üåä Pr√©visions
                        </button>
                    </div>
                </div>
            `;
        }
    });
    
    favoritesList.innerHTML = html;
}
        
        // Fonction pour voir les pr√©visions d'un spot (bonus)
        function viewSpotForecast(spotId) {
            showMessage('info', 'Redirection vers les pr√©visions du spot (√† impl√©menter)');
            // TODO: Rediriger vers l'onglet M√©t√©o avec ce spot pr√©-s√©lectionn√©
        }

        // ========================================
        // RECOMMANDATIONS HARMONIS√âES
        // ========================================
        
        async function generateIntelligentRecommendations() {
            const recommendationsDiv = document.getElementById('recommendations');
            recommendationsDiv.innerHTML = '<div class="loading">üß† Analyse IA harmonis√©e...</div>';
            
            try {
                // Utiliser le gestionnaire centralis√©
                const [aiData, weatherData] = await Promise.all([
                    dataManager.getAIPreferences(dataManager.currentUserId),
                    dataManager.getWeatherData('biarritz-grande-plage')
                ]);
                
                if (aiData) {
                    const recommendations = `
                        <div style="margin-bottom: 15px; padding: 10px; background: linear-gradient(45deg, #e6fffa, #ffffff); border-radius: 8px; border-left: 4px solid #48bb78;">
                            <strong>üß† IA SurfAI v2.0 - Donn√©es Harmonis√©es</strong><br>
                            <span style="font-size: 0.9rem; color: #666;">Analyse ${aiData.totalSessions} sessions + m√©t√©o temps r√©el</span>
                        </div>
                        <div class="card">
                            <h4>üéØ Prochaine session optimale</h4>
                            <p><strong>Conditions personnalis√©es selon votre profil</strong></p>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-top: 10px; font-size: 0.9rem; color: #666;">
                                <div>üåä Optimal: ${aiData.wavePreferences?.optimalHeight?.value || 1.5}m</div>
                                <div>üí® Vent: ${aiData.windPreferences?.preferredDirection || 'SW'} ${aiData.windPreferences?.optimalSpeed?.value || 15}km/h</div>
                                <div>üèñÔ∏è Favori: ${aiData.spotPreferences?.favorite?.name || 'Biarritz'}</div>
                                <div>‚è∞ Heure: ${aiData.timePreferences?.preferredHour || 11}h</div>
                            </div>
                            <div style="margin-top: 15px; padding: 10px; background: #f0f8ff; border-radius: 6px;">
                                <strong>üåä Conditions actuelles:</strong> 
                                Vagues ${weatherData.waveHeight.toFixed(1)}m ‚Ä¢ 
                                Vent ${Math.round(weatherData.windSpeed)}km/h ${weatherData.windDirection} ‚Ä¢ 
                                ${weatherData.tide} mar√©e
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding: 10px; background: #f8fafc; border-radius: 6px; font-size: 0.9rem; color: #666;">
                            üí° <strong>Insights IA:</strong> ${aiData.behavioralInsights?.join(' ‚Ä¢ ') || 'Continuez √† surfer pour plus d\'insights'}
                        </div>
                    `;
                    
                    recommendationsDiv.innerHTML = recommendations;
                } else {
                    throw new Error('Donn√©es IA non disponibles');
                }
                
            } catch (error) {
                console.error('Erreur recommandations harmonis√©es:', error);
                recommendationsDiv.innerHTML = `
                    <div class="error">
                        ‚ùå Erreur analyse harmonis√©e: ${error.message}
                    </div>
                `;
            }
        }

        // ========================================
        // SESSIONS AVEC BOARDS
        // ========================================
        
        async function submitSession() {
            const spotId = document.getElementById('session-spot').value;
            const date = document.getElementById('session-date').value;
            const rating = document.getElementById('session-rating').value;
            const notes = document.getElementById('session-notes').value;
            const boardId = document.getElementById('session-board').value;
            
            if (!spotId || !date || !rating) {
                showMessage('error', 'Veuillez remplir tous les champs obligatoires');
                return;
            }
            
            try {
                // R√©cup√©rer info spot pour envoi backend
                const spot = await dataManager.findSpotById(spotId);
                const spotName = spot ? spot.name : spotId;
                
                const sessionData = {
                    userId: dataManager.currentUserId,
                    spot: spotName,
                    date: `${date}T08:00:00Z`,
                    rating: parseInt(rating),
                    notes: notes,
                    duration: 90,
                    boardId: boardId || null
                };
                
                // Envoyer au backend
                const response = await dataManager.fetchFromBackend('/api/v1/sessions/quick', {
                    method: 'POST',
                    body: JSON.stringify(sessionData)
                });
                
                // Si Supabase disponible, sauvegarder aussi
                if (dataManager.supabase && boardId) {
                    await dataManager.supabase
                        .from('user_sessions')
                        .insert([{
                            user_id: dataManager.currentUserId,
                            spot_id: spotId,
                            board_id: boardId,
                            date: `${date}T08:00:00Z`,
                            rating: parseInt(rating),
                            notes: notes
                        }]);
                }
                
                showMessage('success', 'Session enregistr√©e avec succ√®s !');
                
                // Reset form
                document.getElementById('session-spot').value = '';
                document.getElementById('session-rating').value = '';
                document.getElementById('session-notes').value = '';
                document.getElementById('session-board').value = '';
                
                // Invalider cache IA pour re-calcul
                dataManager.cache.aiPreferences = null;
                
            } catch (error) {
                showMessage('error', `Erreur: ${error.message}`);
            }
        }

        // ========================================
        // GESTION BOARDS HARMONIS√âE
        // ========================================
        
        async function addBoard() {
            const name = document.getElementById('board-name').value;
            const size = document.getElementById('board-size').value;
            const type = document.getElementById('board-type').value;
            const shaper = document.getElementById('board-shaper').value;
            
            if (!name || !size || !type) {
                showMessage('profile', 'error', 'Veuillez remplir tous les champs');
                return;
            }
            
            try {
                const board = { name, size, type };
                await dataManager.saveUserBoard(dataManager.currentUserId, board);
                
                // Reset form
                document.getElementById('board-name').value = '';
                document.getElementById('board-size').value = '';
                document.getElementById('board-type').value = '';
                document.getElementById('board-shaper').value = '';
                
                showMessage('success', 'Board ajout√©e avec succ√®s !');
                
                // Recharger boards dans tous les s√©lecteurs
                await loadUserBoards();
                await loadprofiles();
                
            } catch (error) {
                showMessage('error', `Erreur: ${error.message}`);
            }
        }

        // ========================================
        // CONFIGURATION SUPABASE
        // ========================================
        
        async function testSupabaseConnection() {
            const url = document.getElementById('supabase-url').value;
            const key = document.getElementById('supabase-key').value;
            
            if (!url || !key) {
                showMessage('error', 'Veuillez renseigner URL et cl√© Supabase');
                return;
            }
            
            try {
                // Cr√©er client Supabase
                supabaseClient = supabase.createClient(url, key);
                
                // Test de connexion
                const { data, error } = await supabaseClient
                    .from('spots')
                    .select('count')
                    .limit(1);
                
                if (error) throw new Error(`Erreur Supabase: ${error.message}`);
                
                // Mettre √† jour gestionnaire centralis√©
                dataManager.supabase = supabaseClient;
                
                // Sauvegarder config
                localStorage.setItem('supabase_url', url);
                localStorage.setItem('supabase_key', key);
                
                showMessage('success', `‚úÖ Supabase connect√© ! Base de donn√©es op√©rationnelle.`);
                
                // Recharger donn√©es avec Supabase
                await loadHarmonizedData();
                updateAppStatus();
                
            } catch (error) {
                console.error('Erreur Supabase:', error);
                showMessage('error', `‚ùå ${error.message}`);
            }
        }

        // ========================================
        // FONCTIONS BACKEND (INCHANG√âES)
        // ========================================

        async function checkBackendConnection() {
            try {
                const response = await fetch(`${backendUrl}/health`);
                const data = await response.json();
                
                if (response.ok) {
                    updateBackendStatus(true, 'Backend connect√© et op√©rationnel');
                    document.getElementById('backend-status-indicator').textContent = 'üü¢';
                    return true;
                } else {
                    throw new Error('Backend non disponible');
                }
            } catch (error) {
                updateBackendStatus(false, `Backend non accessible: ${error.message}`);
                document.getElementById('backend-status-indicator').textContent = 'üî¥';
                return false;
            }
        }

        function updateBackendStatus(connected, message) {
            const statusDiv = document.getElementById('backend-status');
            const indicator = document.getElementById('backend-indicator');
            const messageEl = document.getElementById('backend-message');
            
            if (connected) {
                statusDiv.className = 'backend-status connected';
                indicator.textContent = 'üü¢';
            } else {
                statusDiv.className = 'backend-status error';
                indicator.textContent = 'üî¥';
            }
            
            messageEl.textContent = message;
        }

        async function testBackendConnection() {
            const url = document.getElementById('backend-url').value;
            const apiKey = document.getElementById('backend-api-key').value;
            const resultDiv = document.getElementById('backend-test-result');
            
            resultDiv.innerHTML = '<div class="loading">üß™ Test en cours...</div>';
            
            try {
                backendUrl = url;
                backendApiKey = apiKey;
                localStorage.setItem('backend_url', url);
                localStorage.setItem('backend_api_key', apiKey);
                
                // Mettre √† jour gestionnaire centralis√©
                dataManager.backendUrl = url;
                
                const healthResponse = await fetch(`${url}/health`);
                const healthData = await healthResponse.json();
                
                if (!healthResponse.ok) {
                    throw new Error(`Backend non accessible (${healthResponse.status})`);
                }
                
                const aiResponse = await fetch(`${url}/api/v1/ai/test`);
                const aiData = await aiResponse.json();
                
                const weatherResponse = await fetch(`${url}/api/v1/sessions/weather/auto?spot=Biarritz`);
                const weatherData = await weatherResponse.json();
                
                resultDiv.innerHTML = `
                    <div class="success">
                        ‚úÖ Backend SurfAI connect√© !<br>
                        ü•º Health: ${healthData.status}<br>
                        ü§ñ IA Engine: ${aiData.status === 'UPGRADED_TO_V2' ? '‚úÖ v2.0 Fonctionnel' : '‚ö†Ô∏è Basique'}<br>
                        üåä M√©t√©o Auto: ${weatherData.success ? '‚úÖ Fonctionnel' : '‚ùå Erreur'}<br>
                        üìä Confiance m√©t√©o: ${weatherData.weather ? Math.round(weatherData.weather.confidence * 100) + '%' : 'N/A'}
                    </div>
                `;
                
                updateBackendStatus(true, 'Backend SurfAI v2.0 connect√© et fonctionnel');
                updateAppStatus();
                
            } catch (error) {
                console.error('Erreur test backend:', error);
                resultDiv.innerHTML = `
                    <div class="error">
                        ‚ùå ${error.message}<br>
                        V√©rifiez que le backend est d√©marr√© sur le bon port.
                    </div>
                `;
                updateBackendStatus(false, `Erreur: ${error.message}`);
            }
        }

        // ========================================
        // PR√âDICTIONS HARMONIS√âES
        // ========================================
        
        async function generateIntelligentPredictions() {
            const level = document.getElementById('prediction-level').value;
            const days = document.getElementById('prediction-days').value;
            const predictionsDiv = document.getElementById('predictions-list');
            
            predictionsDiv.innerHTML = '<div class="loading">üß† Analyse pr√©dictions harmonis√©es...</div>';
            
            try {
                const aiData = await dataManager.getAIPreferences(dataManager.currentUserId);
                const weatherData = await dataManager.getWeatherData('biarritz-grande-plage');
                
                if (aiData) {
                    const userPrefs = aiData;
                    const currentConditions = weatherData;
                    
                    const predictions = generateMultiDayPredictions(userPrefs, currentConditions, parseInt(days));
                    
                    let predictionsHtml = `
                        <div class="card" style="margin-bottom: 20px; background: linear-gradient(45deg, #f0fff4, #ffffff); border-left: 4px solid #48bb78;">
                            <h4>üß† Analyse IA Harmonis√©e Compl√®te</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 15px;">
                                <div><strong>üìä Sessions analys√©es:</strong> ${userPrefs.totalSessions}</div>
                                <div><strong>üéØ Niveau:</strong> ${level}</div>
                                <div><strong>üìÖ Pr√©visions:</strong> ${days} jours</div>
                                <div><strong>‚≠ê Confiance:</strong> ${Math.round((userPrefs.reliabilityScore || 0.5) * 100)}%</div>
                            </div>
                            <div style="padding: 10px; background: #e6fffa; border-radius: 6px;">
                                <strong>üèÑ‚Äç‚ôÇÔ∏è Donn√©es harmonis√©es:</strong><br>
                                Vagues: ${userPrefs.wavePreferences?.optimalHeight?.value || 1.5}m ‚Ä¢ 
                                Vent: ${userPrefs.windPreferences?.preferredDirection || 'SW'} ${userPrefs.windPreferences?.optimalSpeed?.value || 15}km/h ‚Ä¢ 
                                Spot favori: ${userPrefs.spotPreferences?.favorite?.name || 'Biarritz'}
                            </div>
                        </div>
                    `;
                    
                    predictions.forEach((dayPred, index) => {
                        predictionsHtml += `
                            <div class="card" style="margin-bottom: 15px;">
                                <h4>üìÖ ${dayPred.date}</h4>
                                <div class="forecast-grid">
                                    ${createPredictionCard(dayPred, userPrefs)}
                                </div>
                            </div>
                        `;
                    });
                    
                    predictionsDiv.innerHTML = predictionsHtml;
                } else {
                    throw new Error('Donn√©es IA non disponibles');
                }
                
            } catch (error) {
                console.error('Erreur pr√©dictions harmonis√©es:', error);
                predictionsDiv.innerHTML = `
                    <div class="error">
                        ‚ùå Erreur pr√©dictions harmonis√©es: ${error.message}
                    </div>
                `;
            }
        }

        function generateMultiDayPredictions(userPrefs, baseConditions, days) {
            const predictions = [];
            
            for (let i = 0; i < days; i++) {
                const date = new Date();
                date.setDate(date.getDate() + i + 1);
                
                const waveHeight = baseConditions.waveHeight + (Math.random() - 0.5) * 0.6;
                const windSpeed = baseConditions.windSpeed + (Math.random() - 0.5) * 10;
                
                let score = 5.0;
                const waveDiff = Math.abs(waveHeight - (userPrefs.wavePreferences?.optimalHeight?.value || 1.5));
                const windDiff = Math.abs(windSpeed - (userPrefs.windPreferences?.optimalSpeed?.value || 15));
                
                score -= waveDiff * 1.5;
                score -= windDiff * 0.08;
                score = Math.max(1, Math.min(5, score));
                
                predictions.push({
                    date: date.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' }),
                    conditions: {
                        waveHeight: Math.max(0.3, waveHeight),
                        windSpeed: Math.max(5, windSpeed),
                        windDirection: baseConditions.windDirection
                    },
                    score: score,
                    recommendation: score >= 4 ? "üî• Session exceptionnelle pr√©vue !" : 
                                   score >= 3 ? "üëç Bonnes conditions pour vous" :
                                   "‚ö†Ô∏è Conditions moyennes"
                });
            }
            
            return predictions;
        }

        function createPredictionCard(prediction, userPrefs) {
            let cardClass = 'forecast-card';
            let scoreClass = 'forecast-score';
            
            if (prediction.score >= 4) {
                cardClass += ' excellent';
                scoreClass += ' excellent';
            } else if (prediction.score >= 3) {
                cardClass += ' good';
                scoreClass += ' good';
            } else {
                cardClass += ' average';
                scoreClass += ' average';
            }
            
            return `
                <div class="${cardClass}">
                    <div class="forecast-header">
                        <span class="forecast-date">${prediction.date}</span>
                        <span class="${scoreClass}">${prediction.score.toFixed(1)}/5</span>
                    </div>
                    
                    <div class="forecast-conditions">
                        <div class="condition">üåä ${prediction.conditions.waveHeight.toFixed(1)}m</div>
                        <div class="condition">üí® ${Math.round(prediction.conditions.windSpeed)}km/h</div>
                        <div class="condition">üß≠ ${prediction.conditions.windDirection}</div>
                    </div>
                    
                    <div class="prediction-info">
                        <div class="prediction-recommendation">
                            ${prediction.recommendation}
                        </div>
                        <div style="margin-top: 5px; font-size: 0.8rem; color: #666;">
                            Score harmonis√© bas√© sur ${userPrefs ? userPrefs.totalSessions : 'vos'} sessions analys√©es
                        </div>
                    </div>
                </div>
            `;
        }

        // ========================================
        // FONCTIONS UTILITAIRES ET NAVIGATION
        // ========================================

        function showTab(tabName) {
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'sessions') loadSessions();
            if (tabName === 'spots') loadSpots();
            if (tabName === 'profiles') {
            // L'authentification sera g√©r√©e par showAuthOrprofiles()
            if (supabaseAuth) {
                checkAuthState();
            }
        }
            if (tabName === 'predictions') generateIntelligentPredictions();
        }
        // Nouvelle fonction pour g√©rer l'onglet profiles avec authentification
        async function showAuthOrprofiles() {
            // Montrer l'onglet
            showTab('profiles');
            
            // V√©rifier si connect√©
            if (supabaseAuth) {
                try {
                    const { data: { user } } = await supabaseAuth.auth.getUser();
                    if (user) {
                        currentUser = user;
                        if (window.dataManager) {
                            window.dataManager.currentUserId = user.id;
                        }
                        showprofilesSection();
                        await loadUserprofiles();
                    } else {
                        showAuthSection();
                    }
                } catch (error) {
                    console.error('Erreur auth:', error);
                    showAuthSection();
                }
            } else {
                showAuthSection();
            }
        }
        function loadSessions() {
            const sessionsList = document.getElementById('sessions-list');
            sessionsList.innerHTML = `
                <div class="card">
                    <p>üèÑ‚Äç‚ôÇÔ∏è Vos sessions appara√Ætront ici une fois enregistr√©es.</p>
                    <p>Syst√®me harmonis√© : backend + Supabase + IA v2.0</p>
                </div>
            `;
        }

        function loadSpots() {
    // Charger directement les spots favoris au lieu d'afficher un placeholder
    loadFavoriteSpots();
}

        function loadprofiles() {
            const boardsList = document.getElementById('user-boards-list');
            
            if (userData.boards && userData.boards.length > 0) {
                const boardsHtml = userData.boards.map(board => `
                    <div class="card">
                        <h4>${board.name}</h4>
                        <p>üìè Taille: ${board.size} ‚Ä¢ üèÑ‚Äç‚ôÇÔ∏è Type: ${board.type}</p>
                        <p>üî® Shaper: ${board.shaper}</p>
                    </div>
                `).join('');
                
                boardsList.innerHTML = boardsHtml;
            } else {
                boardsList.innerHTML = `
                    <div class="card">
                        <p>üèÑ‚Äç‚ôÇÔ∏è Ajoutez vos boards ci-dessus.</p>
                        <p>Elles seront int√©gr√©es dans les pr√©dictions IA !</p>
                    </div>
                `;
            }
        }

        function saveprofiles() {
            const nickname = document.getElementById('profiles-nickname').value;
            const level = document.getElementById('profiles-level').value;
            const waveMin = document.getElementById('profiles-wave-min').value;
            const waveMax = document.getElementById('profiles-wave-max').value;
            
            userData.profiles = {
                nickname,
                level,
                wavePreferences: {
                    min: parseFloat(waveMin) || 0.8,
                    max: parseFloat(waveMax) || 2.5
                }
            };
            
            localStorage.setItem('surfai_profiles', JSON.stringify(userData.profiles));
            showMessage('success', 'Profil sauvegard√© !');
        }

        function analyzePatterns() {
            const patternsDiv = document.getElementById('patterns');
            patternsDiv.innerHTML = '<div class="loading">üß† Analyse patterns harmonis√©e...</div>';
            
            setTimeout(() => {
                patternsDiv.innerHTML = `
                    <div class="success">
                        <h4>üéØ Patterns harmonis√©s d√©tect√©s :</h4>
                        <ul style="margin-left: 20px; margin-top: 10px;">
                            <li>üåä Conditions optimales analys√©es par l'IA v2.0</li>
                            <li>üí® Pr√©f√©rences vent bas√©es sur vos sessions</li>
                            <li>üìç Spots favoris selon g√©olocalisation</li>
                            <li>üèÑ‚Äç‚ôÇÔ∏è Boards adapt√©es aux conditions</li>
                        </ul>
                        <p style="margin-top: 15px;">
                            <strong>üí° Syst√®me harmonis√© :</strong> 
                            Backend + Supabase + IA pour des pr√©dictions ultra-pr√©cises !
                        </p>
                    </div>
                `;
            }, 2000);
        }

        function showMessage(type, message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = type;
            messageDiv.innerHTML = message;
            
            const activeTab = document.querySelector('.tab-panel.active');
            activeTab.insertBefore(messageDiv, activeTab.firstChild);
            
            setTimeout(() => messageDiv.remove(), 3000);
        }

        function updateAppStatus() {
            const statusDiv = document.getElementById('app-status');
            statusDiv.innerHTML = `
                <p>üü¢ Backend: Connect√© et fonctionnel</p>
                <p>üü¢ IA Engine: v2.0 Op√©rationnel</p>
                <p>${supabaseClient ? 'üü¢' : 'üî¥'} Supabase: ${supabaseClient ? 'Connect√©' : 'Non configur√©'}</p>
                <p>üü¢ Donn√©es: Harmonis√©es et coh√©rentes</p>
            `;
        }

        function updateDashboard() {
            document.getElementById('total-sessions').textContent = userData.sessions.length;
            document.getElementById('avg-rating').textContent = userData.sessions.length > 0 ? 
                (userData.sessions.reduce((sum, s) => sum + s.rating, 0) / userData.sessions.length).toFixed(1) : '-';
            document.getElementById('favorite-spots').textContent = userData.favoriteSpots.length;
        }
    
        // V√©rification √©tat authentification
async function checkAuthState() {
    if (!supabaseAuth) return;
    
    try {
        const { data: { user } } = await supabaseAuth.auth.getUser();
        if (user) {
            currentUser = user;
            showprofilesSection();
            await loadUserprofiles();
        } else {
            showAuthSection();
        }
    } catch (error) {
        console.error('Erreur v√©rification auth:', error);
        showAuthSection();
    }
}

// Gestion onglets authentification
function switchAuthTab(tab) {
    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
    document.querySelector(`.auth-tab:nth-child(${tab === 'login' ? '1' : '2'})`).classList.add('active');
    
    document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
    document.getElementById(tab === 'login' ? 'login-form' : 'register-form').classList.add('active');
    
    clearMessages('auth');
}
    </script>
</body>
</html>
